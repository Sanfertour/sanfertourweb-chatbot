<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso a Fotoquest - Pamplona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #DC2626; /* Rojo San Fermín para el fondo */
            padding-top: 150px; /* Ajustado para el nuevo alto del encabezado fijo */
        }
        /* Estilos personalizados para los colores corporativos de San Fermín/Pamplona */
        .sap-card {
            background-color: #fef4f4; /* Rojo muy claro para el fondo de la tarjeta */
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* Sombra más pronunciada */
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid #e2e8f0; /* Borde claro */
        }
        .sap-input {
            border: 1px solid #cbd5e1; /* Borde gris medio */
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .sap-input:focus {
            outline: none;
            border-color: #ef4444; /* Borde rojo al enfocar (rojo San Fermín) */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25); /* Resplandor rojo */
        }
        .sap-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sap-button:hover {
            background-color: #dc2626; /* Rojo más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .sap-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* Estilos específicos del selector de idioma */
      .language-selector-container {
    position: absolute; /* Aseguramos que sea posicionado absolutamente */
    top: 4px;            /* Fija a 4px del borde superior de su padre posicionado */
    right: 4px;          /* Fija a 4px del borde derecho de su padre posicionado */
    z-index: 10;
}
        .language-toggle-button { /* Estilo específico para el botón del globo */
            background-color: #A00000; /* Rojo más oscuro para el contraste */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado (forma de píldora) */
            padding: 0.5rem; /* Relleno más pequeño */
            width: 40px; /* Ancho fijo para un círculo pequeño */
            height: 40px; /* Alto fijo para un círculo pequeño */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Icono de globo más grande */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .language-toggle-button:hover {
            background-color: #800000; /* Rojo aún más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .language-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0;
            min-width: 120px;
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .language-dropdown.active {
            display: flex;
        }
        .language-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .language-item:hover {
            background-color: #fef2f2; /* Rojo claro al pasar el ratón por los elementos del menú desplegable */
        }
        .language-item img {
            width: 20px; /* Banderas más pequeñas */
            height: 15px; /* Banderas más pequeñas */
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Estilos específicos del selector de leyenda */
        .legend-selector-container {
            position: absolute; /* Cambiado de relative a absolute para posicionamiento simétrico */
            z-index: 9; /* Z-index inferior al selector de idioma */
            top: 4px; /* Simétrico al botón de idioma */
            left: 4px; /* Alineado a la izquierda */
            right: auto; /* Deshabilitar alineación a la derecha */
        }
        .legend-toggle-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado */
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .legend-toggle-button:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .legend-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .legend-dropdown {
            position: absolute;
            top: 100%;
            left: 0; /* Posición a la izquierda */
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            min-width: 220px; /* Más ancho para el texto de la leyenda */
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .legend-dropdown.active {
            display: flex;
        }
        .legend-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: #333;
        }
        .legend-item i {
            font-size: 1.2rem; /* Tamaño del icono */
        }
        .map-container {
            width: 100%;
            height: 55vh; /* Ligeramente más alto para mejor visualización */
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        .map-iframe {
            width: 100%;
            height: 100%; /* Asegura que el iframe llene su contenedor */
            border: none; /* Elimina el borde por defecto del iframe */
        }
        @media (min-width: 768px) { /* Punto de interrupción md */
            .map-container {
                height: 85vh; /* Altura original para pantallas más grandes, un poco más alta */
            }
        }
        .fullscreen-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .fullscreen-button:hover {
            background-color: #4b5563; /* Gris más oscuro al pasar el ratón */
        }
        .footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            color: #64748b; /* Texto gris pizarra */
            font-size: 0.875rem;
        }
        /* Nuevo estilo de fondo del encabezado */
        .header-background {
            background-image: url('https://i.imgur.com/fbid5J1.jpg'); /* Imagen de fondo actualizada */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* MODIFICACION PARA EL HEADER */
        header {
            min-height: 150px; /* Aumentar la altura mínima del encabezado */
            display: flex; /* Asegura que flexbox funcione para alinear contenido */
            align-items: center; /* Centra verticalmente el contenido */
            justify-content: center; /* Centra horizontalmente el contenido */
            padding: 0; /* Elimina el padding de Tailwind para controlarlo internamente */
        }

        /* Estilos del Chatbot */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100; /* Asegura que esté por encima de otro contenido */
        }
        .chatbot-toggle-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 9999px; /* Círculo completo */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .chatbot-toggle-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .chatbot-panel {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            width: 320px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(10px); /* Ligero desplazamiento inicial */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            position: absolute; /* Posición relativa al contenedor del chatbot */
            bottom: 70px; /* Encima del botón de alternar */
            right: 0;
        }
        .chatbot-panel.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .chatbot-header {
            background-color: #ef4444;
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .chatbot-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #f0f2f5; /* Gris claro para el fondo del chat */
            border-bottom: 1px solid #e2e8f0;
            display: flex; /* Usar flexbox para los mensajes */
            flex-direction: column; /* Apilar mensajes verticalmente */
        }
        .chatbot-input-area {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .chatbot-input {
            flex-grow: 1;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        .chatbot-send-button {
            background-color: #ef4444;
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .chatbot-send-button:hover {
            background-color: #dc2626;
        }
        .chatbot-message {
            margin-bottom: 0.5rem;
            padding: 0.6rem 0.8rem;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word; /* Asegura que las palabras largas se ajusten */
        }
        .chatbot-message.user {
            background-color: #e0f2fe; /* Azul claro para los mensajes del usuario */
            align-self: flex-end;
            margin-left: auto;
        }
        .chatbot-message.bot {
            background-color: #e2e8f0; /* Gris claro para los mensajes del bot */
            align-self: flex-start;
            margin-right: auto;
        }
        .chatbot-loading-dots {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .chatbot-loading-dots:nth-child(1) { animation-delay: -0.32s; }
        .chatbot-loading-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="fixed top-0 left-0 w-full shadow-md z-20 header-background">
        <div class="flex items-center max-w-4xl w-full p-4"> <img id="header-logo" src="https://i.imgur.com/zN8CIl3.jpg" alt="" class="h-12 w-auto mr-4">
            <h1 id="header-title" class="text-3xl font-bold text-red-600 tracking-tight">SanferTour</h1>
        </div>
    </header>

    <div id="app-container" class="relative w-full max-w-4xl mx-auto flex flex-col flex-grow p-4">

        <div class="language-selector-container absolute top-4 right-4">
            <button id="language-toggle" class="language-toggle-button">
                <i class="fas fa-globe text-white"></i>
            </button>
            <div id="language-dropdown" class="language-dropdown">
                <div class="language-item" data-lang="es">
                    <img src="https://flagcdn.com/es.svg" alt="Spanish Flag">
                    <span>Español</span>
                </div>
                <div class="language-item" data-lang="en">
                    <img src="https://flagcdn.com/gb.svg" alt="English Flag">
                    <span>English</span>
                </div>
                <div class="language-item" data-lang="fr">
                    <img src="https://flagcdn.com/fr.svg" alt="French Flag">
                    <span>Français</span>
                </div>
                <div class="language-item" data-lang="de">
                    <img src="https://flagcdn.com/de.svg" alt="German Flag">
                    <span>Deutsch</span>
                </div>
                <div class="language-item" data-lang="it">
                    <img src="https://flagcdn.com/it.svg" alt="Italian Flag">
                    <span>Italiano</span>
                </div>
                <div class="language-item" data-lang="zh">
                    <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag">
                    <span>中文</span>
                </div>
                <div class="language-item" data-lang="eu">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Flag_of_the_Basque_Country_by_Sabino_Arana.svg/220px-Flag_of_the_Basque_Country_by_Sabino_Arana.svg.png" alt="Basque Flag">
                    <span>Euskera</span>
                </div>
                <div class="language-item" data-lang="ja">
                    <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag">
                    <span>日本語</span>
                </div>
                <div class="language-item" data-lang="pt">
                    <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag">
                    <span>Português</span>
                </div>
            </div>
        </div>

        <section id="code-entry-section" class="flex flex-col items-center justify-center flex-grow">
            <div class="sap-card text-center">
                <p id="welcome-instruction" class="text-gray-700 text-lg mb-4 font-semibold"></p>
                
                <h1 id="form-title" class="text-4xl font-bold text-gray-800 mb-4"></h1>
                
                <p id="form-description" class="text-xl text-gray-600 mb-8"></p>
                <form id="code-form" class="space-y-6">
                    <div>
                        <label for="code-input" id="code-label" class="block text-left text-gray-700 text-sm font-medium mb-2">Código de Acceso</label>
                        <input type="text" id="code-input" class="sap-input" placeholder="Introduce tu código aquí" required>
                    </div>
                    <button type="submit" id="submit-button" class="sap-button w-full">Acceder</button>
                    <div id="message-box" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div id="loading-indicator" class="hidden flex items-center justify-center mt-4 text-red-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i> <span id="loading-text">Validando código...</span>
                    </div>
                </form>
            </div>
        </section>

        <section id="es-map-section" class="hidden flex flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-es"></h2>
                <p class="text-gray-700 mb-4" id="map-description-es"></p>
                
                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-es" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-es" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-es">Gastroguía y Ocio Nocturno</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-es">Audioguía</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-es-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Pantalla Completa
                </button>
                <div class="map-container">
                    <iframe id="es-map-iframe" class="map-iframe" src="https://illustrious-sherbet-a1b6fc.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-es" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-es" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-es">Chatbot de Ayuda</span>
                        <button id="chatbot-close-es" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-es" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-es" class="chatbot-input" placeholder="Escribe tu mensaje...">
                        <button id="chatbot-send-es" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="en-map-section" class="hidden flex flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-en"></h2>
                <p class="text-gray-700 mb-4" id="map-description-en"></p>

                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-en" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-en" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-en">Gastronomy and Nightlife Guide</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-en">Audio Guide</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-en-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Fullscreen
                </button>
                <div class="map-container">
                    <iframe id="en-map-iframe" class="map-iframe" src="https://68359b9a0a454de624224515--scintillating-capybara-21e569.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-en" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-en" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-en">Help Chatbot</span>
                        <button id="chatbot-close-en" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-en" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-en" class="chatbot-input" placeholder="Type your message...">
                        <button id="chatbot-send-en" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <footer class="footer">
        <p id="copyright-text">&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado.</p>
    </footer>

    <script>
        // --- Gestión de idiomas ---
        const translations = {
            es: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // Este texto ya no se usa visualmente en este punto
                formTitle: "Bienvenido a la primera experiencia GoTour de Pamplona", // Nuevo título principal
                formDescription: "La ciudad en tus auriculares, a tu ritmo, a tu manera...", // Nuevo subtítulo
                codeLabel: "Código de Acceso",
                codeInputPlaceholder: "Introduce tu código aquí",
                submitButton: "Acceder",
                invalidCode: "Código inválido. Por favor, inténtalo de nuevo.",
                codeExpired: "El código ha caducado. Por favor, contacta con el administrador.",
                usageLimitExceeded: "Este código ha excedido su límite de usos. Por favor, contacta con el administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bienvenido a Sanfertour", // Texto actualizado
                mapDescription: "La única experiencia Gotour: a tu manera y a tu ritmo.", // Texto actualizado
                legendToggle: "Leyenda del Mapa",
                legendGastro: "Gastroguía y Ocio Nocturno",
                legendAudioguia: "Audioguía",
                fullscreenButton: "Pantalla Completa",
                chatbotHeaderText: "Chatbot de Ayuda",
                chatbotInputPlaceholder: "Escribe tu mensaje...",
                chatbotInitialMessage: "¡Hola! Soy tu guía de Sanfertour. Pregúntame sobre los lugares de interés, historia, gastronomía y cultura de Pamplona. ✨",
                chatbotErrorMessage: "Lo siento, hubo un error al obtener la respuesta. Por favor, inténtalo de nuevo.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado."
            },
            en: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // This text is no longer used visually at this point
                formTitle: "Welcome to Pamplona's First GoTour Experience", // New main title
                formDescription: "The city in your headphones, at your pace, your way...", // New subtitle
                codeLabel: "Access Code",
                codeInputPlaceholder: "Enter your code here",
                submitButton: "Access",
                invalidCode: "Invalid code. Please try again.",
                codeExpired: "The code has expired. Please contact the administrator.",
                usageLimitExceeded: "This code has exceeded its usage limit. Please contact the administrator.",
                loadingText: "Validating code...",
                mapTitle: "Welcome to Sanfertour", // Updated text
                mapDescription: "The unique Gotour experience: your way, your pace.", // Updated text
                legendToggle: "Map Legend",
                legendGastro: "Gastronomy and Nightlife Guide",
                legendAudioguia: "Audio Guide",
                fullscreenButton: "Fullscreen",
                chatbotHeaderText: "Help Chatbot",
                chatbotInputPlaceholder: "Type your message...",
                chatbotInitialMessage: "Hi! I'm your Sanfertour guide. Ask me about Pamplona's sights, history, gastronomy, and culture. ✨",
                chatbotErrorMessage: "Sorry, there was an error getting the response. Please try again.",
                copyright: "&copy; 2025 Fotoquest Pamplona. All rights reserved. Downloading, reproduction, or unauthorized use is prohibited."
            },
            fr: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bienvenue à la première expérience GoTour de Pampelune",
                formDescription: "La ville dans vos écouteurs, à votre rythme, à votre manière...",
                codeLabel: "Code d'accès",
                codeInputPlaceholder: "Entrez votre code ici",
                submitButton: "Accéder",
                invalidCode: "Code invalide. Veuillez réessayer.",
                codeExpired: "Le code a expiré. Veuillez contacter l'administrateur.",
                usageLimitExceeded: "Ce code a dépassé sa limite d'utilisation. Veuillez contacter l'administrateur.",
                loadingText: "Validation du code...",
                mapTitle: "Bienvenue à Sanfertour",
                mapDescription: "L'expérience Gotour unique : à votre manière et à votre rythme.",
                legendToggle: "Légende de la carte",
                legendGastro: "Guide gastronomique et vie nocturne",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Plein écran",
                chatbotHeaderText: "Chatbot d'aide",
                chatbotInputPlaceholder: "Écrivez votre message...",
                chatbotInitialMessage: "Bonjour ! Je suis votre guide Sanfertour. Posez-moi des questions sur les sites, l'histoire, la gastronomie et la culture de Pampelune. ✨",
                chatbotErrorMessage: "Désolé, une erreur s'est produite lors de la récupération de la réponse. Veuillez réessayer.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tous droits réservés. Téléchargement, reproduction ou utilisation non autorisée interdits."
            },
            de: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Willkommen zum ersten GoTour Erlebnis in Pamplona",
                formDescription: "Die Stadt in Ihren Kopfhörern, in Ihrem Tempo, auf Ihre Weise...",
                codeLabel: "Zugangscode",
                codeInputPlaceholder: "Geben Sie hier Ihren Code ein",
                submitButton: "Zugang",
                invalidCode: "Ungültiger Code. Bitte versuchen Sie es erneut.",
                codeExpired: "Der Code ist abgelaufen. Bitte kontaktieren Sie den Administrator.",
                usageLimitExceeded: "Dieser Code hat sein Nutzungslimit überschritten. Bitte kontaktieren Sie den Administrator.",
                loadingText: "Code wird überprüft...",
                mapTitle: "Willkommen bei Sanfertour",
                mapDescription: "Das einzigartige Gotour-Erlebnis: auf Ihre Weise, in Ihrem Tempo.",
                legendToggle: "Kartenlegende",
                legendGastro: "Gastronomie- und Nachtlebenführer",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Vollbild",
                chatbotHeaderText: "Hilfe-Chatbot",
                chatbotInputPlaceholder: "Geben Sie Ihre Nachricht ein...",
                chatbotInitialMessage: "Hallo! Ich bin Ihr Sanfertour-Guide. Fragen Sie mich nach den Sehenswürdigkeiten, der Geschichte, der Gastronomie und der Kultur Pamplonas. ✨",
                chatbotErrorMessage: "Entschuldigung, beim Abrufen der Antwort ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Alle Rechte vorbehalten. Herunterladen, Reproduktion oder unbefugte Nutzung ist untersagt."
            },
            it: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Benvenuti alla prima esperienza GoTour di Pamplona",
                formDescription: "La città nelle tue cuffie, al tuo ritmo, a modo tuo...",
                codeLabel: "Codice di Accesso",
                codeInputPlaceholder: "Inserisci il tuo codice qui",
                submitButton: "Accedi",
                invalidCode: "Codice non valido. Si prega di riprovare.",
                codeExpired: "Il codice è scaduto. Si prega di contattare l'amministratore.",
                usageLimitExceeded: "Questo codice ha superato il limite di utilizzi. Si prega di contattare l'amministratore.",
                loadingText: "Validazione codice...",
                mapTitle: "Benvenuti a Sanfertour",
                mapDescription: "L'esperienza Gotour unica: a modo tuo, al tuo ritmo.",
                legendToggle: "Legenda della Mappa",
                legendGastro: "Guida gastronomica e vita notturna",
                legendAudioguia: "Audioguida",
                fullscreenButton: "Schermo intero",
                chatbotHeaderText: "Chatbot di aiuto",
                chatbotInputPlaceholder: "Scrivi il tuo messaggio...",
                chatbotInitialMessage: "Ciao! Sono la tua guida Sanfertour. Chiedimi informazioni sui luoghi d'interesse, la storia, la gastronomia e la cultura di Pamplona. ✨",
                chatbotErrorMessage: "Siamo spiacenti, si è verificato un errore durante il recupero della risposta. Riprova.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tutti i diritti riservati. Download, riproduzione o utilizzo non autorizzato sono proibiti."
            },
            zh: {
                headerLogoAlt: "Sanfertour 标志",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "欢迎来到潘普洛纳的首次GoTour体验",
                formDescription: "城市在你的耳机里，按照你的节奏，你的方式...",
                codeLabel: "访问代码",
                codeInputPlaceholder: "在此输入您的代码",
                submitButton: "访问",
                invalidCode: "代码无效。请再试一次。",
                codeExpired: "代码已过期。请联系管理员。",
                usageLimitExceeded: "此代码已超出使用限制。请联系管理员。",
                loadingText: "正在验证代码...",
                mapTitle: "欢迎来到Sanfertour",
                mapDescription: "独特的Gotour体验：随心所欲，按自己的节奏。",
                legendToggle: "地图图例",
                legendGastro: "美食和夜生活指南",
                legendAudioguia: "语音导览",
                fullscreenButton: "全屏",
                chatbotHeaderText: "帮助聊天机器人",
                chatbotInputPlaceholder: "输入您的消息...",
                chatbotInitialMessage: "你好！我是你的Sanfertour向导。向我询问潘普洛纳的景点、历史、美食和文化。✨",
                chatbotErrorMessage: "抱歉，获取回复时出错。请重试。",
                copyright: "&copy; 2025 Fotoquest Pamplona. 保留所有权利。禁止下载、复制或未经授权的使用。"
            },
            eu: {
                headerLogoAlt: "Sanfertour Logotipoa",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Ongi etorri Iruñeko lehen GoTour esperientziara",
                formDescription: "Hiria zure aurikularretan, zure erritmoan, zure moduan...",
                codeLabel: "Sarbide Kodea",
                codeInputPlaceholder: "Sartu zure kodea hemen",
                submitButton: "Sartu",
                invalidCode: "Kode baliogabea. Mesedez, saiatu berriro.",
                codeExpired: "Kodea iraungi da. Mesedez, jarri harremanetan administratzailearekin.",
                usageLimitExceeded: "Kode honek erabilera muga gainditu du. Mesedez, jarri harremanetan administratzailearekin.",
                loadingText: "Kodea balioztatzen...",
                mapTitle: "Ongi etorri Sanfertour-era",
                mapDescription: "Gotour esperientzia bakarra: zure erara eta zure erritmoan.",
                legendToggle: "Maparen Kondaira",
                legendGastro: "Gastro-gida eta Gaueko Aisia",
                legendAudioguia: "Audiogida",
                fullscreenButton: "Pantaila osoa",
                chatbotHeaderText: "Laguntza-txatbota",
                chatbotInputPlaceholder: "Idatzi zure mezua...",
                chatbotInitialMessage: "Kaixo! Sanfertour-eko zure gida naiz. Galdetu Iruñeko leku interesgarriei, historiari, gastronomiari eta kulturari buruz. ✨",
                chatbotErrorMessage: "Barkatu, erantzuna lortzean errorea gertatu da. Saiatu berriro.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Eskubide guztiak erreserbatuta. Debekatuta dago deskargatzea, erreproduzitzea edo baimenik gabe erabiltzea."
            },
            ja: {
                headerLogoAlt: "Sanfertour ロゴ",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "パンプローナ初のGoTour体験へようこそ",
                formDescription: "イヤホンで街を、あなたのペースで、あなたの方法で...",
                codeLabel: "アクセスコード",
                codeInputPlaceholder: "ここにコードを入力してください",
                submitButton: "アクセス",
                invalidCode: "無効なコードです。もう一度お試しください。",
                codeExpired: "コードの有効期限が切れました。管理者にお問い合わせください。",
                usageLimitExceeded: "このコードは使用制限を超えました。管理者にお問い合わせください。",
                loadingText: "コードを検証中...",
                mapTitle: "Sanfertourへようこそ",
                mapDescription: "独自のGotour体験：あなたのやり方で、あなたのペースで。",
                legendToggle: "地図の凡例",
                legendGastro: "グルメ＆ナイトライフガイド",
                legendAudioguia: "オーディオガイド",
                fullscreenButton: "全画面表示",
                copyright: "&copy; 2025 Pamplona Fotoquest. 全著作権所有。ダウンロード、複製、または無断使用は禁止されています。"
            },
            pt: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bem-vindo à primeira experiência GoTour de Pamplona",
                formDescription: "A cidade nos seus fones de ouvido, ao seu ritmo, do seu jeito...",
                codeLabel: "Código de Acesso",
                codeInputPlaceholder: "Insira seu código aqui",
                submitButton: "Acessar",
                invalidCode: "Código inválido. Por favor, tente novamente.",
                codeExpired: "O código expirou. Por favor, entre em contato com o administrador.",
                usageLimitExceeded: "Este código excedeu o limite de usos. Por favor, entre em contato com o administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bem-vindo ao Sanfertour",
                mapDescription: "A experiência Gotour única: do seu jeito, no seu ritmo.",
                legendToggle: "Legenda do Mapa",
                legendGastro: "Guia de Gastronomia e Vida Noturna",
                legendAudioguia: "Audioguia",
                fullscreenButton: "Tela Cheia",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Proibido download, reprodução o uso no autorizado."
            }
        };

        // Usando flagcdn.com para banderas más realistas
        const flags = {
            es: "https://flagcdn.com/es.svg",
            en: "https://flagcdn.com/gb.svg", // Bandera del Reino Unido para inglés
            fr: "https://flagcdn.com/fr.sVg",
            de: "https://flagcdn.com/de.svg",
            it: "https://flagcdn.com/it.svg",
            zh: "https://flagcdn.com/cn.svg", // Bandera de China para chino
            eu: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Flag_of_the_Basque_Country_by_Sabino_Arana.svg/220px-Flag_of_the_Basque_Country_by_Sabino_Arana.svg.png", // Bandera vasca
            ja: "https://flagcdn.com/jp.svg",
            pt: "https://flagcdn.com/pt.svg"
        };

        let currentLang = 'es'; // Idioma por defecto, se sobrescribirá por la detección del navegador

        // Historial de chat global para cada idioma
        // La instrucción del sistema se envía en la Netlify Function para mayor seguridad y control.
        const chatHistoryEs = [{ role: "model", parts: [{ text: translations['es'].chatbotInitialMessage }] }];
        const chatHistoryEn = [{ role: "model", parts: [{ text: translations['en'].chatbotInitialMessage }] }];
        // Añadir otros idiomas si es necesario, por ejemplo: chatHistoryFr = [...]

        // Obtener elementos
        const headerLogo = document.getElementById('header-logo');
        const headerTitle = document.getElementById('header-title');
        const languageToggle = document.getElementById('language-toggle');
        const languageDropdown = document.getElementById('language-dropdown');
        const welcomeInstruction = document.getElementById('welcome-instruction');

        const formTitle = document.getElementById('form-title');
        const formDescription = document.getElementById('form-description');
        const codeLabel = document.getElementById('code-label');
        const codeInput = document.getElementById('code-input');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        const loadingText = document.getElementById('loading-text');

        const esMapSection = document.getElementById('es-map-section');
        const enMapSection = document.getElementById('en-map-section');
        const esMapIframe = document.getElementById('es-map-iframe');
        const enMapIframe = document.getElementById('en-map-iframe');
        const fullscreenEsMapButton = document.getElementById('fullscreen-es-map');
        const fullscreenEnMapButton = document.getElementById('fullscreen-en-map');
        const copyrightText = document.getElementById('copyright-text');

        // Nuevos elementos de leyenda
        const legendToggleEs = document.getElementById('legend-toggle-es');
        const legendDropdownEs = document.getElementById('legend-dropdown-es');
        const legendToggleEn = document.getElementById('legend-toggle-en');
        const legendDropdownEn = document.getElementById('legend-dropdown-en');

        // Elementos del Chatbot
        const chatbotToggleEs = document.getElementById('chatbot-toggle-es');
        const chatbotPanelEs = document.getElementById('chatbot-panel-es');
        const chatbotCloseEs = document.getElementById('chatbot-close-es');
        const chatbotHeaderTextEs = document.getElementById('chatbot-header-text-es');
        const chatbotMessagesEs = document.getElementById('chatbot-messages-es');
        const chatbotInputEs = document.getElementById('chatbot-input-es');
        const chatbotSendEs = document.getElementById('chatbot-send-es');

        const chatbotToggleEn = document.getElementById('chatbot-toggle-en');
        const chatbotPanelEn = document.getElementById('chatbot-panel-en');
        const chatbotCloseEn = document.getElementById('chatbot-close-en');
        const chatbotHeaderTextEn = document.getElementById('chatbot-header-text-en');
        const chatbotMessagesEn = document.getElementById('chatbot-messages-en');
        const chatbotInputEn = document.getElementById('chatbot-input-en');
        const chatbotSendEn = document.getElementById('chatbot-send-en');

        // Función para añadir un mensaje a la pantalla de chat
        function addMessageToChat(messagesDiv, text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message', sender);
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Desplazar hasta el final
        }

        // Función para mostrar/ocultar puntos de carga
        function showLoadingDots(messagesDiv, show) {
            let loadingDiv = messagesDiv.querySelector('.loading-dots-container');
            if (show) {
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.classList.add('chatbot-message', 'bot', 'loading-dots-container');
                    loadingDiv.innerHTML = `
                        <div class="chatbot-loading-dots"></div>
                        <div class="chatbot-loading-dots"></div>
                        <div class="chatbot-loading-dots"></div>
                    `;
                    messagesDiv.appendChild(loadingDiv);
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                if (loadingDiv) {
                    messagesDiv.removeChild(loadingDiv);
                }
            }
        }

        // --- Lógica de envío de mensajes del Chatbot (Integrado con la API de Gemini) ---
        async function sendMessage(inputField, messagesDiv, chatHistory, lang) {
            const messageText = inputField.value.trim();
            if (messageText === '') return;

            addMessageToChat(messagesDiv, messageText, 'user');
            chatHistory.push({ role: "user", parts: [{ text: messageText }] });
            inputField.value = ''; // Limpiar entrada
            inputField.disabled = true; // Deshabilitar entrada mientras se espera la respuesta
            
            // Determinar qué botón de envío deshabilitar según el chatbot activo
            let activeSendButton;
            if (messagesDiv.id === 'chatbot-messages-es') {
                activeSendButton = chatbotSendEs;
            } else if (messagesDiv.id === 'chatbot-messages-en') {
                activeSendButton = chatbotSendEn;
            }
            if (activeSendButton) {
                activeSendButton.disabled = true; // Deshabilitar botón de envío
            }
            
            showLoadingDots(messagesDiv, true); // Mostrar puntos de carga

            try {
                // Llamar a la Netlify Function en lugar de directamente a la API de Gemini
                // La URL es relativa a la raíz de tu sitio Netlify
                const response = await fetch('/.netlify/functions/chatbot', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory }) // Enviar el historial de chat
                });

                const result = await response.json();

                showLoadingDots(messagesDiv, false); // Ocultar puntos de carga

                if (response.ok && result.text) { // Si la respuesta de la función es OK y contiene texto
                    const botResponse = result.text;
                    addMessageToChat(messagesDiv, botResponse, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                } else {
                    addMessageToChat(messagesDiv, translations[lang].chatbotErrorMessage, 'bot');
                    console.error('Error de la Netlify Function o respuesta inesperada:', result);
                }
            } catch (error) {
                showLoadingDots(messagesDiv, false); // Ocultar puntos de carga en caso de error
                addMessageToChat(messagesDiv, translations[lang].chatbotErrorMessage, 'bot');
                console.error('Error al llamar a la Netlify Function:', error);
            } finally {
                inputField.disabled = false; // Volver a habilitar la entrada
                if (activeSendButton) {
                    activeSendButton.disabled = false; // Volver a habilitar el botón de envío
                }
                inputField.focus(); // Enfocar la entrada para el siguiente mensaje
            }
        }

        // Actualizar contenido según el idioma seleccionado
        function updateContent(lang) {
            currentLang = lang;
            const t = translations[lang];

            headerLogo.alt = t.headerLogoAlt;
            headerTitle.textContent = t.headerTitle;
            welcomeInstruction.textContent = t.welcomeInstruction; // welcomeInstruction ahora estará vacío
            formTitle.textContent = t.formTitle; // Nuevo título principal
            formDescription.textContent = t.formDescription; // Nuevo subtítulo
            codeLabel.textContent = t.codeLabel;
            codeInput.placeholder = t.codeInputPlaceholder;
            submitButton.textContent = t.submitButton;
            loadingText.textContent = t.loadingText;
            copyrightText.innerHTML = t.copyright; // Usar innerHTML para copyright para permitir entidades HTML

            // Actualizar contenido de la sección del mapa
            // Estos elementos ahora tienen IDs específicos para facilitar la selección
            const esMapTitle = document.getElementById('map-title-es');
            const esMapDescription = document.getElementById('map-description-es');
            const enMapTitle = document.getElementById('map-title-en');
            const enMapDescription = document.getElementById('map-description-en');

            if (esMapTitle) esMapTitle.textContent = translations['es'].mapTitle;
            if (esMapDescription) esMapDescription.textContent = translations['es'].mapDescription;
            if (enMapTitle) enMapTitle.textContent = translations['en'].mapTitle;
            if (enMapDescription) enMapDescription.textContent = translations['en'].mapDescription;
            
            // Actualizar elementos de leyenda según el idioma actual
            if (document.getElementById('legend-gastro-es')) {
                document.getElementById('legend-gastro-es').textContent = translations['es'].legendGastro;
                document.getElementById('legend-audioguia-es').textContent = translations['es'].legendAudioguia;
            }
            if (document.getElementById('legend-gastro-en')) {
                document.getElementById('legend-gastro-en').textContent = translations['en'].legendGastro;
                document.getElementById('legend-audioguia-en').textContent = translations['en'].legendAudioguia;
            }
            
            fullscreenEsMapButton.textContent = t.fullscreenButton;
            fullscreenEnMapButton.textContent = t.fullscreenButton;

            // Actualizar textos del chatbot y mensaje inicial
            if (chatbotHeaderTextEs) chatbotHeaderTextEs.textContent = t.chatbotHeaderText;
            if (chatbotInputEs) chatbotInputEs.placeholder = t.chatbotInputPlaceholder;
            if (chatbotMessagesEs && chatbotMessagesEs.children.length > 0) {
                // Solo actualizar el mensaje inicial si es el primer mensaje y del bot
                if (chatHistoryEs.length === 1 && chatHistoryEs[0].role === 'model') {
                     chatbotMessagesEs.children[0].textContent = t.chatbotInitialMessage;
                }
            }

            if (chatbotHeaderTextEn) chatbotHeaderTextEn.textContent = t.chatbotHeaderText;
            if (chatbotInputEn) chatbotInputEn.placeholder = t.chatbotInputPlaceholder;
            if (chatbotMessagesEn && chatbotMessagesEn.children.length > 0) {
                // Solo actualizar el mensaje inicial si es el primer mensaje y del bot
                if (chatHistoryEn.length === 1 && chatHistoryEn[0].role === 'model') {
                    chatbotMessagesEn.children[0].textContent = t.chatbotInitialMessage;
                }
            }
        }

        // --- Detección del idioma del navegador al cargar ---
        function getBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage; // Obtener el idioma del navegador
            const primaryLang = browserLang.split('-')[0]; // Obtener el código de idioma principal (por ejemplo, 'es' de 'es-ES')
            if (translations[primaryLang]) {
                return primaryLang;
            }
            return 'es'; // Por defecto, español si el idioma detectado no es compatible
        }

        // Inicializar con el idioma detectado
        currentLang = getBrowserLanguage();
        updateContent(currentLang);


        // Alternar selector de idioma
        languageToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Evitar que el clic se propague al documento y cierre el menú desplegable
            languageDropdown.classList.toggle('active');
        });

        // Manejar clics en elementos de idioma
        document.querySelectorAll('.language-item').forEach(item => {
            item.addEventListener('click', (event) => {
                const newLang = event.currentTarget.dataset.lang;
                updateContent(newLang);
                languageDropdown.classList.remove('active');
            });
        });

        // Cerrar menú desplegable si se hace clic fuera
        document.addEventListener('click', (event) => {
            const languageSelectorContainer = document.querySelector('.language-selector-container');
            if (!languageSelectorContainer.contains(event.target)) {
                languageDropdown.classList.remove('active');
            }
            // Cerrar menús desplegables de leyenda si se hace clic fuera
            const legendSelectorContainerEs = document.querySelector('#es-map-section .legend-selector-container');
            if (legendSelectorContainerEs && !legendSelectorContainerEs.contains(event.target)) {
                legendDropdownEs.classList.remove('active');
            }
            const legendSelectorContainerEn = document.querySelector('#en-map-section .legend-selector-container');
            if (legendSelectorContainerEn && !legendSelectorContainerEn.contains(event.target)) {
                legendDropdownEn.classList.remove('active');
            }
        });

        // --- Funcionalidad de alternar leyenda ---
        if (legendToggleEs) {
            legendToggleEs.addEventListener('click', (event) => {
                event.stopPropagation();
                legendDropdownEs.classList.toggle('active');
                // Cerrar otro menú desplegable de leyenda si está abierto
                if (legendDropdownEn && legendDropdownEn.classList.contains('active')) {
                    legendDropdownEn.classList.remove('active');
                }
            });
        }
        if (legendToggleEn) {
            legendToggleEn.addEventListener('click', (event) => {
                event.stopPropagation();
                legendDropdownEn.classList.toggle('active');
                // Cerrar otro menú desplegable de leyenda si está abierto
                if (legendDropdownEs && legendDropdownEs.classList.contains('active')) {
                    legendDropdownEs.classList.remove('active');
                }
            });
        }

        // --- Envío de formulario y validación de código ---
        const codeForm = document.getElementById('code-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const codeEntrySection = document.getElementById('code-entry-section');

        // IMPORTANTE: Esta es la URL de tu Google App Script que maneja el doPost
        const APP_SCRIPT_VALIDATION_URL = 'https://script.google.com/macros/s/AKfycbzUyJfJtItPTqhueAFuK3ltfbuYK4hSE8nXO5Hv6EkfiMajmLSSv0HuUrMadW5-diBabA/exec';

        codeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = codeInput.value.trim();

            messageBox.classList.add('hidden');
            messageBox.textContent = ''; // Limpiar mensajes anteriores
            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;
            codeInput.disabled = true;

            try {
                // Enviar el código como application/x-www-form-urlencoded para compatibilidad con doPost
                const response = await fetch(APP_SCRIPT_VALIDATION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ codigo: code }) // Envía el código como 'codigo=VALOR'
                });

                const result = await response.json();

                if (result.valido) { // Tu App Script devuelve 'valido'
                    const mapLanguage = result.urlRedireccion.includes('illustrious-sherbet') ? 'es' : 'en';
                    
                    codeEntrySection.classList.add('hidden');
                    if (mapLanguage === 'es') {
                        esMapSection.classList.remove('hidden');
                        esMapSection.classList.add('flex');
                        enMapSection.classList.add('hidden'); // Asegurarse de que el otro mapa esté oculto
                    } else if (mapLanguage === 'en') {
                        enMapSection.classList.remove('hidden');
                        enMapSection.classList.add('flex');
                        esMapSection.classList.add('hidden'); // Asegurarse de que el otro mapa esté oculto
                    }
                    // Actualizar el contenido de la sección del mapa al idioma validado
                    updateContent(mapLanguage);

                    // Establecer el mensaje inicial del chatbot según el idioma
                    if (mapLanguage === 'es') {
                        // Limpiar mensajes anteriores y añadir el inicial
                        chatbotMessagesEs.innerHTML = ''; 
                        addMessageToChat(chatbotMessagesEs, translations['es'].chatbotInitialMessage, 'bot');
                        chatHistoryEs.length = 0; // Limpiar historial
                        chatHistoryEs.push({ role: "model", parts: [{ text: translations['es'].chatbotInitialMessage }] }); // Añadir solo el mensaje inicial del bot
                    } else if (mapLanguage === 'en') {
                        // Limpiar mensajes anteriores y añadir el inicial
                        chatbotMessagesEn.innerHTML = '';
                        addMessageToChat(chatbotMessagesEn, translations['en'].chatbotInitialMessage, 'bot');
                        chatHistoryEn.length = 0; // Limpiar historial
                        chatHistoryEn.push({ role: "model", parts: [{ text: translations['en'].chatbotInitialMessage }] }); // Añadir solo el mensaje inicial del bot
                    }


                } else {
                    // Mostrar mensaje de error específico del App Script
                    let errorMessage = translations[currentLang].invalidCode; // Mensaje por defecto
                    if (result.mensaje === 'Este código ha caducado.' || result.mensaje === 'This code has expired.') {
                        errorMessage = translations[currentLang].codeExpired;
                    } else if (result.mensaje === 'Este código ha excedido el número máximo de usos.' || result.mensaje === 'This code has exceeded the maximum number of uses.') {
                        errorMessage = translations[currentLang].usageLimitExceeded;
                    } else if (result.mensaje) {
                        errorMessage = result.mensaje; // Otros mensajes específicos del App Script
                    }
                    messageBox.textContent = errorMessage;
                    messageBox.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error validating code:', error);
                messageBox.textContent = 'Error de conexión. Por favor, inténtalo de nuevo más tarde.';
                messageBox.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
                codeInput.disabled = false;
            }
        });

        // --- Funcionalidad de pantalla completa para iframes ---
        function requestFullscreen(iframeElement) {
            if (iframeElement.requestFullscreen) {
                iframeElement.requestFullscreen();
            } else if (iframeElement.mozRequestFullScreen) { /* Firefox */
                iframeElement.mozRequestFullScreen();
            } else if (iframeElement.webkitRequestFullscreen) { /* Chrome, Safari y Opera */
                iframeElement.webkitRequestFullscreen();
            } else if (iframeElement.msRequestFullscreen) { /* IE/Edge */
                iframeElement.msRequestFullscreen();
            }
        }

        fullscreenEsMapButton.addEventListener('click', () => {
            requestFullscreen(esMapIframe);
        });

        fullscreenEnMapButton.addEventListener('click', () => {
            requestFullscreen(enMapIframe);
        });

        // --- Funcionalidad de alternar Chatbot ---
        function setupChatbot(toggleButton, panel, closeButton, messagesDiv, inputField, sendButton, chatHistoryArray, lang) {
            toggleButton.addEventListener('click', () => {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Desplazar hasta el final al abrir
                    inputField.focus(); // Enfocar el campo de entrada
                }
            });

            closeButton.addEventListener('click', () => {
                panel.classList.remove('active');
            });

            sendButton.addEventListener('click', () => {
                sendMessage(inputField, messagesDiv, chatHistoryArray, lang);
            });

            inputField.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage(inputField, messagesDiv, chatHistoryArray, lang);
                }
            });
        }

        // Inicializar chatbots con sus respectivos historiales de chat
        if (chatbotToggleEs) {
            setupChatbot(chatbotToggleEs, chatbotPanelEs, chatbotCloseEs, chatbotMessagesEs, chatbotInputEs, chatbotSendEs, chatHistoryEs, 'es');
        }
        if (chatbotToggleEn) {
            setupChatbot(chatbotToggleEn, chatbotPanelEn, chatbotCloseEn, chatbotMessagesEn, chatbotInputEn, chatbotSendEn, chatHistoryEn, 'en');
        }

    </script>
</body>
=======
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso a Fotoquest - Pamplona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #DC2626; /* Rojo San Fermín para el fondo */
            padding-top: 150px; /* Ajustado para el nuevo alto del encabezado fijo */
        }
        /* Estilos personalizados para los colores corporativos de San Fermín/Pamplona */
        .sap-card {
            background-color: #fef4f4; /* Rojo muy claro para el fondo de la tarjeta */
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* Sombra más pronunciada */
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid #e2e8f0; /* Borde claro */
        }
        .sap-input {
            border: 1px solid #cbd5e1; /* Borde gris medio */
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .sap-input:focus {
            outline: none;
            border-color: #ef4444; /* Borde rojo al enfocar (rojo San Fermín) */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25); /* Resplandor rojo */
        }
        .sap-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sap-button:hover {
            background-color: #dc2626; /* Rojo más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .sap-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* Estilos específicos del selector de idioma */
        .language-selector-container {
            position: relative; /* Cambiado de absoluto a relativo al contenedor padre */
            z-index: 10;
        }
        .language-toggle-button { /* Estilo específico para el botón del globo */
            background-color: #A00000; /* Rojo más oscuro para el contraste */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado (forma de píldora) */
            padding: 0.5rem; /* Relleno más pequeño */
            width: 40px; /* Ancho fijo para un círculo pequeño */
            height: 40px; /* Alto fijo para un círculo pequeño */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Icono de globo más grande */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .language-toggle-button:hover {
            background-color: #800000; /* Rojo aún más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .language-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0;
            min-width: 120px;
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .language-dropdown.active {
            display: flex;
        }
        .language-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .language-item:hover {
            background-color: #fef2f2; /* Rojo claro al pasar el ratón por los elementos del menú desplegable */
        }
        .language-item img {
            width: 20px; /* Banderas más pequeñas */
            height: 15px; /* Banderas más pequeñas */
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Estilos específicos del selector de leyenda */
        .legend-selector-container {
            position: absolute; /* Cambiado de relative a absolute para posicionamiento simétrico */
            z-index: 9; /* Z-index inferior al selector de idioma */
            top: 4px; /* Simétrico al botón de idioma */
            left: 4px; /* Alineado a la izquierda */
            right: auto; /* Deshabilitar alineación a la derecha */
        }
        .legend-toggle-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado */
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .legend-toggle-button:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .legend-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .legend-dropdown {
            position: absolute;
            top: 100%;
            left: 0; /* Posición a la izquierda */
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            min-width: 220px; /* Más ancho para el texto de la leyenda */
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .legend-dropdown.active {
            display: flex;
        }
        .legend-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: #333;
        }
        .legend-item i {
            font-size: 1.2rem; /* Tamaño del icono */
        }
        .map-container {
            width: 100%;
            height: 55vh; /* Ligeramente más alto para mejor visualización */
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        .map-iframe {
            width: 100%;
            height: 100%; /* Asegura que el iframe llene su contenedor */
            border: none; /* Elimina el borde por defecto del iframe */
        }
        @media (min-width: 768px) { /* Punto de interrupción md */
            .map-container {
                height: 85vh; /* Altura original para pantallas más grandes, un poco más alta */
            }
        }
        .fullscreen-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .fullscreen-button:hover {
            background-color: #4b5563; /* Gris más oscuro al pasar el ratón */
        }
        .footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            color: #64748b; /* Texto gris pizarra */
            font-size: 0.875rem;
        }
        /* Nuevo estilo de fondo del encabezado */
        .header-background {
            background-image: url('https://i.imgur.com/fbid5J1.jpg'); /* Imagen de fondo actualizada */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* MODIFICACION PARA EL HEADER */
        header {
            min-height: 150px; /* Aumentar la altura mínima del encabezado */
            display: flex; /* Asegura que flexbox funcione para alinear contenido */
            align-items: center; /* Centra verticalmente el contenido */
            justify-content: center; /* Centra horizontalmente el contenido */
            padding: 0; /* Elimina el padding de Tailwind para controlarlo internamente */
        }

        /* Estilos del Chatbot */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100; /* Asegura que esté por encima de otro contenido */
        }
        .chatbot-toggle-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 9999px; /* Círculo completo */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .chatbot-toggle-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .chatbot-panel {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            width: 320px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(10px); /* Ligero desplazamiento inicial */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            position: absolute; /* Posición relativa al contenedor del chatbot */
            bottom: 70px; /* Encima del botón de alternar */
            right: 0;
        }
        .chatbot-panel.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .chatbot-header {
            background-color: #ef4444;
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .chatbot-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #f0f2f5; /* Gris claro para el fondo del chat */
            border-bottom: 1px solid #e2e8f0;
            display: flex; /* Usar flexbox para los mensajes */
            flex-direction: column; /* Apilar mensajes verticalmente */
        }
        .chatbot-input-area {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .chatbot-input {
            flex-grow: 1;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        .chatbot-send-button {
            background-color: #ef4444;
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .chatbot-send-button:hover {
            background-color: #dc2626;
        }
        .chatbot-message {
            margin-bottom: 0.5rem;
            padding: 0.6rem 0.8rem;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word; /* Asegura que las palabras largas se ajusten */
        }
        .chatbot-message.user {
            background-color: #e0f2fe; /* Azul claro para los mensajes del usuario */
            align-self: flex-end;
            margin-left: auto;
        }
        .chatbot-message.bot {
            background-color: #e2e8f0; /* Gris claro para los mensajes del bot */
            align-self: flex-start;
            margin-right: auto;
        }
        .chatbot-loading-dots {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .chatbot-loading-dots:nth-child(1) { animation-delay: -0.32s; }
        .chatbot-loading-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="fixed top-0 left-0 w-full shadow-md z-20 header-background">
        <div class="flex items-center max-w-4xl w-full p-4"> <img id="header-logo" src="https://i.imgur.com/zN8CIl3.jpg" alt="" class="h-12 w-auto mr-4">
            <h1 id="header-title" class="text-3xl font-bold text-red-600 tracking-tight">SanferTour</h1>
        </div>
    </header>

    <div id="app-container" class="relative w-full max-w-4xl mx-auto flex flex-col flex-grow p-4">

        <div class="language-selector-container absolute top-4 right-4">
            <button id="language-toggle" class="language-toggle-button">
                <i class="fas fa-globe text-white"></i>
            </button>
            <div id="language-dropdown" class="language-dropdown">
                <div class="language-item" data-lang="es">
                    <img src="https://flagcdn.com/es.svg" alt="Spanish Flag">
                    <span>Español</span>
                </div>
                <div class="language-item" data-lang="en">
                    <img src="https://flagcdn.com/gb.svg" alt="English Flag">
                    <span>English</span>
                </div>
                <div class="language-item" data-lang="fr">
                    <img src="https://flagcdn.com/fr.svg" alt="French Flag">
                    <span>Français</span>
                </div>
                <div class="language-item" data-lang="de">
                    <img src="https://flagcdn.com/de.svg" alt="German Flag">
                    <span>Deutsch</span>
                </div>
                <div class="language-item" data-lang="it">
                    <img src="https://flagcdn.com/it.svg" alt="Italian Flag">
                    <span>Italiano</span>
                </div>
                <div class="language-item" data-lang="zh">
                    <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag">
                    <span>中文</span>
                </div>
                <div class="language-item" data-lang="eu">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Flag_of_the_Basque_Country_by_Sabino_Arana.svg/220px-Flag_of_the_Basque_Country_by_Sabino_Arana.svg.png" alt="Basque Flag">
                    <span>Euskera</span>
                </div>
                <div class="language-item" data-lang="ja">
                    <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag">
                    <span>日本語</span>
                </div>
                <div class="language-item" data-lang="pt">
                    <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag">
                    <span>Português</span>
                </div>
            </div>
        </div>

        <section id="code-entry-section" class="flex flex-col items-center justify-center flex-grow">
            <div class="sap-card text-center">
                <p id="welcome-instruction" class="text-gray-700 text-lg mb-4 font-semibold"></p>
                
                <h1 id="form-title" class="text-4xl font-bold text-gray-800 mb-4"></h1>
                
                <p id="form-description" class="text-xl text-gray-600 mb-8"></p>
                <form id="code-form" class="space-y-6">
                    <div>
                        <label for="code-input" id="code-label" class="block text-left text-gray-700 text-sm font-medium mb-2">Código de Acceso</label>
                        <input type="text" id="code-input" class="sap-input" placeholder="Introduce tu código aquí" required>
                    </div>
                    <button type="submit" id="submit-button" class="sap-button w-full">Acceder</button>
                    <div id="message-box" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div id="loading-indicator" class="hidden flex items-center justify-center mt-4 text-red-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i> <span id="loading-text">Validando código...</span>
                    </div>
                </form>
            </div>
        </section>

        <section id="es-map-section" class="hidden flex flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-es"></h2>
                <p class="text-gray-700 mb-4" id="map-description-es"></p>
                
                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-es" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-es" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-es">Gastroguía y Ocio Nocturno</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-es">Audioguía</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-es-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Pantalla Completa
                </button>
                <div class="map-container">
                    <iframe id="es-map-iframe" class="map-iframe" src="https://illustrious-sherbet-a1b6fc.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-es" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-es" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-es">Chatbot de Ayuda</span>
                        <button id="chatbot-close-es" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-es" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-es" class="chatbot-input" placeholder="Escribe tu mensaje...">
                        <button id="chatbot-send-es" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="en-map-section" class="hidden flex flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-en"></h2>
                <p class="text-gray-700 mb-4" id="map-description-en"></p>

                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-en" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-en" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-en">Gastronomy and Nightlife Guide</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-en">Audio Guide</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-en-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Fullscreen
                </button>
                <div class="map-container">
                    <iframe id="en-map-iframe" class="map-iframe" src="https://68359b9a0a454de624224515--scintillating-capybara-21e569.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-en" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-en" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-en">Help Chatbot</span>
                        <button id="chatbot-close-en" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-en" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-en" class="chatbot-input" placeholder="Type your message...">
                        <button id="chatbot-send-en" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <footer class="footer">
        <p id="copyright-text">&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado.</p>
    </footer>

    <script>
        // --- Gestión de idiomas ---
        const translations = {
            es: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // Este texto ya no se usa visualmente en este punto
                formTitle: "Bienvenido a la primera experiencia GoTour de Pamplona", // Nuevo título principal
                formDescription: "La ciudad en tus auriculares, a tu ritmo, a tu manera...", // Nuevo subtítulo
                codeLabel: "Código de Acceso",
                codeInputPlaceholder: "Introduce tu código aquí",
                submitButton: "Acceder",
                invalidCode: "Código inválido. Por favor, inténtalo de nuevo.",
                codeExpired: "El código ha caducado. Por favor, contacta con el administrador.",
                usageLimitExceeded: "Este código ha excedido su límite de usos. Por favor, contacta con el administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bienvenido a Sanfertour", // Texto actualizado
                mapDescription: "La única experiencia Gotour: a tu manera y a tu ritmo.", // Texto actualizado
                legendToggle: "Leyenda del Mapa",
                legendGastro: "Gastroguía y Ocio Nocturno",
                legendAudioguia: "Audioguía",
                fullscreenButton: "Pantalla Completa",
                chatbotHeaderText: "Chatbot de Ayuda",
                chatbotInputPlaceholder: "Escribe tu mensaje...",
                chatbotInitialMessage: "¡Hola! Soy tu guía de Sanfertour. Pregúntame sobre los lugares de interés, historia, gastronomía y cultura de Pamplona. ✨",
                chatbotErrorMessage: "Lo siento, hubo un error al obtener la respuesta. Por favor, inténtalo de nuevo.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado."
            },
            en: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // This text is no longer used visually at this point
                formTitle: "Welcome to Pamplona's First GoTour Experience", // New main title
                formDescription: "The city in your headphones, at your pace, your way...", // New subtitle
                codeLabel: "Access Code",
                codeInputPlaceholder: "Enter your code here",
                submitButton: "Access",
                invalidCode: "Invalid code. Please try again.",
                codeExpired: "The code has expired. Please contact the administrator.",
                usageLimitExceeded: "This code has exceeded its usage limit. Please contact the administrator.",
                loadingText: "Validating code...",
                mapTitle: "Welcome to Sanfertour", // Updated text
                mapDescription: "The unique Gotour experience: your way, your pace.", // Updated text
                legendToggle: "Map Legend",
                legendGastro: "Gastronomy and Nightlife Guide",
                legendAudioguia: "Audio Guide",
                fullscreenButton: "Fullscreen",
                chatbotHeaderText: "Help Chatbot",
                chatbotInputPlaceholder: "Type your message...",
                chatbotInitialMessage: "Hi! I'm your Sanfertour guide. Ask me about Pamplona's sights, history, gastronomy, and culture. ✨",
                chatbotErrorMessage: "Sorry, there was an error getting the response. Please try again.",
                copyright: "&copy; 2025 Fotoquest Pamplona. All rights reserved. Downloading, reproduction, or unauthorized use is prohibited."
            },
            fr: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bienvenue à la première expérience GoTour de Pampelune",
                formDescription: "La ville dans vos écouteurs, à votre rythme, à votre manière...",
                codeLabel: "Code d'accès",
                codeInputPlaceholder: "Entrez votre code ici",
                submitButton: "Accéder",
                invalidCode: "Code invalide. Veuillez réessayer.",
                codeExpired: "Le code a expiré. Veuillez contacter l'administrateur.",
                usageLimitExceeded: "Ce code a dépassé sa limite d'utilisation. Veuillez contacter l'administrateur.",
                loadingText: "Validation du code...",
                mapTitle: "Bienvenue à Sanfertour",
                mapDescription: "L'expérience Gotour unique : à votre manière et à votre rythme.",
                legendToggle: "Légende de la carte",
                legendGastro: "Guide gastronomique et vie nocturne",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Plein écran",
                chatbotHeaderText: "Chatbot d'aide",
                chatbotInputPlaceholder: "Écrivez votre message...",
                chatbotInitialMessage: "Bonjour ! Je suis votre guide Sanfertour. Posez-moi des questions sur les sites, l'histoire, la gastronomie et la culture de Pampelune. ✨",
                chatbotErrorMessage: "Désolé, une erreur s'est produite lors de la récupération de la réponse. Veuillez réessayer.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tous droits réservés. Téléchargement, reproduction ou utilisation non autorisée interdits."
            },
            de: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Willkommen zum ersten GoTour Erlebnis in Pamplona",
                formDescription: "Die Stadt in Ihren Kopfhörern, in Ihrem Tempo, auf Ihre Weise...",
                codeLabel: "Zugangscode",
                codeInputPlaceholder: "Geben Sie hier Ihren Code ein",
                submitButton: "Zugang",
                invalidCode: "Ungültiger Code. Bitte versuchen Sie es erneut.",
                codeExpired: "Der Code ist abgelaufen. Bitte kontaktieren Sie den Administrator.",
                usageLimitExceeded: "Dieser Code hat sein Nutzungslimit überschritten. Bitte kontaktieren Sie den Administrator.",
                loadingText: "Code wird überprüft...",
                mapTitle: "Willkommen bei Sanfertour",
                mapDescription: "Das einzigartige Gotour-Erlebnis: auf Ihre Weise, in Ihrem Tempo.",
                legendToggle: "Kartenlegende",
                legendGastro: "Gastronomie- und Nachtlebenführer",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Vollbild",
                chatbotHeaderText: "Hilfe-Chatbot",
                chatbotInputPlaceholder: "Geben Sie Ihre Nachricht ein...",
                chatbotInitialMessage: "Hallo! Ich bin Ihr Sanfertour-Guide. Fragen Sie mich nach den Sehenswürdigkeiten, der Geschichte, der Gastronomie und der Kultur Pamplonas. ✨",
                chatbotErrorMessage: "Entschuldigung, beim Abrufen der Antwort ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Alle Rechte vorbehalten. Herunterladen, Reproduktion oder unbefugte Nutzung ist untersagt."
            },
            it: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Benvenuti alla prima esperienza GoTour di Pamplona",
                formDescription: "La città nelle tue cuffie, al tuo ritmo, a modo tuo...",
                codeLabel: "Codice di Accesso",
                codeInputPlaceholder: "Inserisci il tuo codice qui",
                submitButton: "Accedi",
                invalidCode: "Codice non valido. Si prega di riprovare.",
                codeExpired: "Il codice è scaduto. Si prega di contattare l'amministratore.",
                usageLimitExceeded: "Questo codice ha superato il limite di utilizzi. Si prega di contattare l'amministratore.",
                loadingText: "Validazione codice...",
                mapTitle: "Benvenuti a Sanfertour",
                mapDescription: "L'esperienza Gotour unica: a modo tuo, al tuo ritmo.",
                legendToggle: "Legenda della Mappa",
                legendGastro: "Guida gastronomica e vita notturna",
                legendAudioguia: "Audioguida",
                fullscreenButton: "Schermo intero",
                chatbotHeaderText: "Chatbot di aiuto",
                chatbotInputPlaceholder: "Scrivi il tuo messaggio...",
                chatbotInitialMessage: "Ciao! Sono la tua guida Sanfertour. Chiedimi informazioni sui luoghi d'interesse, la storia, la gastronomia e la cultura di Pamplona. ✨",
                chatbotErrorMessage: "Siamo spiacenti, si è verificato un errore durante il recupero della risposta. Riprova.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tutti i diritti riservati. Download, riproduzione o utilizzo non autorizzato sono proibiti."
            },
            zh: {
                headerLogoAlt: "Sanfertour 标志",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "欢迎来到潘普洛纳的首次GoTour体验",
                formDescription: "城市在你的耳机里，按照你的节奏，你的方式...",
                codeLabel: "访问代码",
                codeInputPlaceholder: "在此输入您的代码",
                submitButton: "访问",
                invalidCode: "代码无效。请再试一次。",
                codeExpired: "代码已过期。请联系管理员。",
                usageLimitExceeded: "此代码已超出使用限制。请联系管理员。",
                loadingText: "正在验证代码...",
                mapTitle: "欢迎来到Sanfertour",
                mapDescription: "独特的Gotour体验：随心所欲，按自己的节奏。",
                legendToggle: "地图图例",
                legendGastro: "美食和夜生活指南",
                legendAudioguia: "语音导览",
                fullscreenButton: "全屏",
                chatbotHeaderText: "帮助聊天机器人",
                chatbotInputPlaceholder: "输入您的消息...",
                chatbotInitialMessage: "你好！我是你的Sanfertour向导。向我询问潘普洛纳的景点、历史、美食和文化。✨",
                chatbotErrorMessage: "抱歉，获取回复时出错。请重试。",
                copyright: "&copy; 2025 Fotoquest Pamplona. 保留所有权利。禁止下载、复制或未经授权的使用。"
            },
            eu: {
                headerLogoAlt: "Sanfertour Logotipoa",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Ongi etorri Iruñeko lehen GoTour esperientziara",
                formDescription: "Hiria zure aurikularretan, zure erritmoan, zure moduan...",
                codeLabel: "Sarbide Kodea",
                codeInputPlaceholder: "Sartu zure kodea hemen",
                submitButton: "Sartu",
                invalidCode: "Kode baliogabea. Mesedez, saiatu berriro.",
                codeExpired: "Kodea iraungi da. Mesedez, jarri harremanetan administratzailearekin.",
                usageLimitExceeded: "Kode honek erabilera muga gainditu du. Mesedez, jarri harremanetan administratzailearekin.",
                loadingText: "Kodea balioztatzen...",
                mapTitle: "Ongi etorri Sanfertour-era",
                mapDescription: "Gotour esperientzia bakarra: zure erara eta zure erritmoan.",
                legendToggle: "Maparen Kondaira",
                legendGastro: "Gastro-gida eta Gaueko Aisia",
                legendAudioguia: "Audiogida",
                fullscreenButton: "Pantaila osoa",
                chatbotHeaderText: "Laguntza-txatbota",
                chatbotInputPlaceholder: "Idatzi zure mezua...",
                chatbotInitialMessage: "Kaixo! Sanfertour-eko zure gida naiz. Galdetu Iruñeko leku interesgarriei, historiari, gastronomiari eta kulturari buruz. ✨",
                chatbotErrorMessage: "Barkatu, erantzuna lortzean errorea gertatu da. Saiatu berriro.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Eskubide guztiak erreserbatuta. Debekatuta dago deskargatzea, erreproduzitzea edo baimenik gabe erabiltzea."
            },
            ja: {
                headerLogoAlt: "Sanfertour ロゴ",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "パンプローナ初のGoTour体験へようこそ",
                formDescription: "イヤホンで街を、あなたのペースで、あなたの方法で...",
                codeLabel: "アクセスコード",
                codeInputPlaceholder: "ここにコードを入力してください",
                submitButton: "アクセス",
                invalidCode: "無効なコードです。もう一度お試しください。",
                codeExpired: "コードの有効期限が切れました。管理者にお問い合わせください。",
                usageLimitExceeded: "このコードは使用制限を超えました。管理者にお問い合わせください。",
                loadingText: "コードを検証中...",
                mapTitle: "Sanfertourへようこそ",
                mapDescription: "独自のGotour体験：あなたのやり方で、あなたのペースで。",
                legendToggle: "地図の凡例",
                legendGastro: "グルメ＆ナイトライフガイド",
                legendAudioguia: "オーディオガイド",
                fullscreenButton: "全画面表示",
                copyright: "&copy; 2025 Pamplona Fotoquest. 全著作権所有。ダウンロード、複製、または無断使用は禁止されています。"
            },
            pt: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bem-vindo à primeira experiência GoTour de Pamplona",
                formDescription: "A cidade nos seus fones de ouvido, ao seu ritmo, do seu jeito...",
                codeLabel: "Código de Acesso",
                codeInputPlaceholder: "Insira seu código aqui",
                submitButton: "Acessar",
                invalidCode: "Código inválido. Por favor, tente novamente.",
                codeExpired: "O código expirou. Por favor, entre em contato com o administrador.",
                usageLimitExceeded: "Este código excedeu o limite de usos. Por favor, entre em contato com o administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bem-vindo ao Sanfertour",
                mapDescription: "A experiência Gotour única: do seu jeito, no seu ritmo.",
                legendToggle: "Legenda do Mapa",
                legendGastro: "Guia de Gastronomia e Vida Noturna",
                legendAudioguia: "Audioguia",
                fullscreenButton: "Tela Cheia",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Proibido download, reprodução o uso no autorizado."
            }
        };

        // Usando flagcdn.com para banderas más realistas
        const flags = {
            es: "https://flagcdn.com/es.svg",
            en: "https://flagcdn.com/gb.svg", // Bandera del Reino Unido para inglés
            fr: "https://flagcdn.com/fr.sVg",
            de: "https://flagcdn.com/de.svg",
            it: "https://flagcdn.com/it.svg",
            zh: "https://flagcdn.com/cn.svg", // Bandera de China para chino
            eu: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Flag_of_the_Basque_Country_by_Sabino_Arana.svg/220px-Flag_of_the_Basque_Country_by_Sabino_Arana.svg.png", // Bandera vasca
            ja: "https://flagcdn.com/jp.svg",
            pt: "https://flagcdn.com/pt.svg"
        };

        let currentLang = 'es'; // Idioma por defecto, se sobrescribirá por la detección del navegador

        // Historial de chat global para cada idioma
        // La instrucción del sistema se envía en la Netlify Function para mayor seguridad y control.
        const chatHistoryEs = [{ role: "model", parts: [{ text: translations['es'].chatbotInitialMessage }] }];
        const chatHistoryEn = [{ role: "model", parts: [{ text: translations['en'].chatbotInitialMessage }] }];
        // Añadir otros idiomas si es necesario, por ejemplo: chatHistoryFr = [...]

        // Obtener elementos
        const headerLogo = document.getElementById('header-logo');
        const headerTitle = document.getElementById('header-title');
        const languageToggle = document.getElementById('language-toggle');
        const languageDropdown = document.getElementById('language-dropdown');
        const welcomeInstruction = document.getElementById('welcome-instruction');

        const formTitle = document.getElementById('form-title');
        const formDescription = document.getElementById('form-description');
        const codeLabel = document.getElementById('code-label');
        const codeInput = document.getElementById('code-input');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        const loadingText = document.getElementById('loading-text');

        const esMapSection = document.getElementById('es-map-section');
        const enMapSection = document.getElementById('en-map-section');
        const esMapIframe = document.getElementById('es-map-iframe');
        const enMapIframe = document.getElementById('en-map-iframe');
        const fullscreenEsMapButton = document.getElementById('fullscreen-es-map');
        const fullscreenEnMapButton = document.getElementById('fullscreen-en-map');
        const copyrightText = document.getElementById('copyright-text');

        // Nuevos elementos de leyenda
        const legendToggleEs = document.getElementById('legend-toggle-es');
        const legendDropdownEs = document.getElementById('legend-dropdown-es');
        const legendToggleEn = document.getElementById('legend-toggle-en');
        const legendDropdownEn = document.getElementById('legend-dropdown-en');

        // Elementos del Chatbot
        const chatbotToggleEs = document.getElementById('chatbot-toggle-es');
        const chatbotPanelEs = document.getElementById('chatbot-panel-es');
        const chatbotCloseEs = document.getElementById('chatbot-close-es');
        const chatbotHeaderTextEs = document.getElementById('chatbot-header-text-es');
        const chatbotMessagesEs = document.getElementById('chatbot-messages-es');
        const chatbotInputEs = document.getElementById('chatbot-input-es');
        const chatbotSendEs = document.getElementById('chatbot-send-es');

        const chatbotToggleEn = document.getElementById('chatbot-toggle-en');
        const chatbotPanelEn = document.getElementById('chatbot-panel-en');
        const chatbotCloseEn = document.getElementById('chatbot-close-en');
        const chatbotHeaderTextEn = document.getElementById('chatbot-header-text-en');
        const chatbotMessagesEn = document.getElementById('chatbot-messages-en');
        const chatbotInputEn = document.getElementById('chatbot-input-en');
        const chatbotSendEn = document.getElementById('chatbot-send-en');

        // Función para añadir un mensaje a la pantalla de chat
        function addMessageToChat(messagesDiv, text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message', sender);
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Desplazar hasta el final
        }

        // Función para mostrar/ocultar puntos de carga
        function showLoadingDots(messagesDiv, show) {
            let loadingDiv = messagesDiv.querySelector('.loading-dots-container');
            if (show) {
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.classList.add('chatbot-message', 'bot', 'loading-dots-container');
                    loadingDiv.innerHTML = `
                        <div class="chatbot-loading-dots"></div>
                        <div class="chatbot-loading-dots"></div>
                        <div class="chatbot-loading-dots"></div>
                    `;
                    messagesDiv.appendChild(loadingDiv);
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } else {
                if (loadingDiv) {
                    messagesDiv.removeChild(loadingDiv);
                }
            }
        }

        // --- Lógica de envío de mensajes del Chatbot (Integrado con la API de Gemini) ---
        async function sendMessage(inputField, messagesDiv, chatHistory, lang) {
            const messageText = inputField.value.trim();
            if (messageText === '') return;

            addMessageToChat(messagesDiv, messageText, 'user');
            chatHistory.push({ role: "user", parts: [{ text: messageText }] });
            inputField.value = ''; // Limpiar entrada
            inputField.disabled = true; // Deshabilitar entrada mientras se espera la respuesta
            
            // Determinar qué botón de envío deshabilitar según el chatbot activo
            let activeSendButton;
            if (messagesDiv.id === 'chatbot-messages-es') {
                activeSendButton = chatbotSendEs;
            } else if (messagesDiv.id === 'chatbot-messages-en') {
                activeSendButton = chatbotSendEn;
            }
            if (activeSendButton) {
                activeSendButton.disabled = true; // Deshabilitar botón de envío
            }
            
            showLoadingDots(messagesDiv, true); // Mostrar puntos de carga

            try {
                // Llamar a la Netlify Function en lugar de directamente a la API de Gemini
                // La URL es relativa a la raíz de tu sitio Netlify
                const response = await fetch('/.netlify/functions/chatbot', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: chatHistory }) // Enviar el historial de chat
                });

                const result = await response.json();

                showLoadingDots(messagesDiv, false); // Ocultar puntos de carga

                if (response.ok && result.text) { // Si la respuesta de la función es OK y contiene texto
                    const botResponse = result.text;
                    addMessageToChat(messagesDiv, botResponse, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                } else {
                    addMessageToChat(messagesDiv, translations[lang].chatbotErrorMessage, 'bot');
                    console.error('Error de la Netlify Function o respuesta inesperada:', result);
                }
            } catch (error) {
                showLoadingDots(messagesDiv, false); // Ocultar puntos de carga en caso de error
                addMessageToChat(messagesDiv, translations[lang].chatbotErrorMessage, 'bot');
                console.error('Error al llamar a la Netlify Function:', error);
            } finally {
                inputField.disabled = false; // Volver a habilitar la entrada
                if (activeSendButton) {
                    activeSendButton.disabled = false; // Volver a habilitar el botón de envío
                }
                inputField.focus(); // Enfocar la entrada para el siguiente mensaje
            }
        }

        // Actualizar contenido según el idioma seleccionado
        function updateContent(lang) {
            currentLang = lang;
            const t = translations[lang];

            headerLogo.alt = t.headerLogoAlt;
            headerTitle.textContent = t.headerTitle;
            welcomeInstruction.textContent = t.welcomeInstruction; // welcomeInstruction ahora estará vacío
            formTitle.textContent = t.formTitle; // Nuevo título principal
            formDescription.textContent = t.formDescription; // Nuevo subtítulo
            codeLabel.textContent = t.codeLabel;
            codeInput.placeholder = t.codeInputPlaceholder;
            submitButton.textContent = t.submitButton;
            loadingText.textContent = t.loadingText;
            copyrightText.innerHTML = t.copyright; // Usar innerHTML para copyright para permitir entidades HTML

            // Actualizar contenido de la sección del mapa
            // Estos elementos ahora tienen IDs específicos para facilitar la selección
            const esMapTitle = document.getElementById('map-title-es');
            const esMapDescription = document.getElementById('map-description-es');
            const enMapTitle = document.getElementById('map-title-en');
            const enMapDescription = document.getElementById('map-description-en');

            if (esMapTitle) esMapTitle.textContent = translations['es'].mapTitle;
            if (esMapDescription) esMapDescription.textContent = translations['es'].mapDescription;
            if (enMapTitle) enMapTitle.textContent = translations['en'].mapTitle;
            if (enMapDescription) enMapDescription.textContent = translations['en'].mapDescription;
            
            // Actualizar elementos de leyenda según el idioma actual
            if (document.getElementById('legend-gastro-es')) {
                document.getElementById('legend-gastro-es').textContent = translations['es'].legendGastro;
                document.getElementById('legend-audioguia-es').textContent = translations['es'].legendAudioguia;
            }
            if (document.getElementById('legend-gastro-en')) {
                document.getElementById('legend-gastro-en').textContent = translations['en'].legendGastro;
                document.getElementById('legend-audioguia-en').textContent = translations['en'].legendAudioguia;
            }
            
            fullscreenEsMapButton.textContent = t.fullscreenButton;
            fullscreenEnMapButton.textContent = t.fullscreenButton;

            // Actualizar textos del chatbot y mensaje inicial
            if (chatbotHeaderTextEs) chatbotHeaderTextEs.textContent = t.chatbotHeaderText;
            if (chatbotInputEs) chatbotInputEs.placeholder = t.chatbotInputPlaceholder;
            if (chatbotMessagesEs && chatbotMessagesEs.children.length > 0) {
                // Solo actualizar el mensaje inicial si es el primer mensaje y del bot
                if (chatHistoryEs.length === 1 && chatHistoryEs[0].role === 'model') {
                     chatbotMessagesEs.children[0].textContent = t.chatbotInitialMessage;
                }
            }

            if (chatbotHeaderTextEn) chatbotHeaderTextEn.textContent = t.chatbotHeaderText;
            if (chatbotInputEn) chatbotInputEn.placeholder = t.chatbotInputPlaceholder;
            if (chatbotMessagesEn && chatbotMessagesEn.children.length > 0) {
                // Solo actualizar el mensaje inicial si es el primer mensaje y del bot
                if (chatHistoryEn.length === 1 && chatHistoryEn[0].role === 'model') {
                    chatbotMessagesEn.children[0].textContent = t.chatbotInitialMessage;
                }
            }
        }

        // --- Detección del idioma del navegador al cargar ---
        function getBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage; // Obtener el idioma del navegador
            const primaryLang = browserLang.split('-')[0]; // Obtener el código de idioma principal (por ejemplo, 'es' de 'es-ES')
            if (translations[primaryLang]) {
                return primaryLang;
            }
            return 'es'; // Por defecto, español si el idioma detectado no es compatible
        }

        // Inicializar con el idioma detectado
        currentLang = getBrowserLanguage();
        updateContent(currentLang);


        // Alternar selector de idioma
        languageToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Evitar que el clic se propague al documento y cierre el menú desplegable
            languageDropdown.classList.toggle('active');
        });

        // Manejar clics en elementos de idioma
        document.querySelectorAll('.language-item').forEach(item => {
            item.addEventListener('click', (event) => {
                const newLang = event.currentTarget.dataset.lang;
                updateContent(newLang);
                languageDropdown.classList.remove('active');
            });
        });

        // Cerrar menú desplegable si se hace clic fuera
        document.addEventListener('click', (event) => {
            const languageSelectorContainer = document.querySelector('.language-selector-container');
            if (!languageSelectorContainer.contains(event.target)) {
                languageDropdown.classList.remove('active');
            }
            // Cerrar menús desplegables de leyenda si se hace clic fuera
            const legendSelectorContainerEs = document.querySelector('#es-map-section .legend-selector-container');
            if (legendSelectorContainerEs && !legendSelectorContainerEs.contains(event.target)) {
                legendDropdownEs.classList.remove('active');
            }
            const legendSelectorContainerEn = document.querySelector('#en-map-section .legend-selector-container');
            if (legendSelectorContainerEn && !legendSelectorContainerEn.contains(event.target)) {
                legendDropdownEn.classList.remove('active');
            }
        });

        // --- Funcionalidad de alternar leyenda ---
        if (legendToggleEs) {
            legendToggleEs.addEventListener('click', (event) => {
                event.stopPropagation();
                legendDropdownEs.classList.toggle('active');
                // Cerrar otro menú desplegable de leyenda si está abierto
                if (legendDropdownEn && legendDropdownEn.classList.contains('active')) {
                    legendDropdownEn.classList.remove('active');
                }
            });
        }
        if (legendToggleEn) {
            legendToggleEn.addEventListener('click', (event) => {
                event.stopPropagation();
                legendDropdownEn.classList.toggle('active');
                // Cerrar otro menú desplegable de leyenda si está abierto
                if (legendDropdownEs && legendDropdownEs.classList.contains('active')) {
                    legendDropdownEs.classList.remove('active');
                }
            });
        }

        // --- Envío de formulario y validación de código ---
        const codeForm = document.getElementById('code-form');
        const loadingIndicator = document.getElementById('loading-indicator');
        const codeEntrySection = document.getElementById('code-entry-section');

        // IMPORTANTE: Esta es la URL de tu Google App Script que maneja el doPost
        const APP_SCRIPT_VALIDATION_URL = 'https://script.google.com/macros/s/AKfycbzUyJfJtItPTqhueAFuK3ltfbuYK4hSE8nXO5Hv6EkfiMajmLSSv0HuUrMadW5-diBabA/exec';

        codeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = codeInput.value.trim();

            messageBox.classList.add('hidden');
            messageBox.textContent = ''; // Limpiar mensajes anteriores
            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;
            codeInput.disabled = true;

            try {
                // Enviar el código como application/x-www-form-urlencoded para compatibilidad con doPost
                const response = await fetch(APP_SCRIPT_VALIDATION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ codigo: code }) // Envía el código como 'codigo=VALOR'
                });

                const result = await response.json();

                if (result.valido) { // Tu App Script devuelve 'valido'
                    const mapLanguage = result.urlRedireccion.includes('illustrious-sherbet') ? 'es' : 'en';
                    
                    codeEntrySection.classList.add('hidden');
                    if (mapLanguage === 'es') {
                        esMapSection.classList.remove('hidden');
                        esMapSection.classList.add('flex');
                        enMapSection.classList.add('hidden'); // Asegurarse de que el otro mapa esté oculto
                    } else if (mapLanguage === 'en') {
                        enMapSection.classList.remove('hidden');
                        enMapSection.classList.add('flex');
                        esMapSection.classList.add('hidden'); // Asegurarse de que el otro mapa esté oculto
                    }
                    // Actualizar el contenido de la sección del mapa al idioma validado
                    updateContent(mapLanguage);

                    // Establecer el mensaje inicial del chatbot según el idioma
                    if (mapLanguage === 'es') {
                        // Limpiar mensajes anteriores y añadir el inicial
                        chatbotMessagesEs.innerHTML = ''; 
                        addMessageToChat(chatbotMessagesEs, translations['es'].chatbotInitialMessage, 'bot');
                        chatHistoryEs.length = 0; // Limpiar historial
                        chatHistoryEs.push({ role: "model", parts: [{ text: translations['es'].chatbotInitialMessage }] }); // Añadir solo el mensaje inicial del bot
                    } else if (mapLanguage === 'en') {
                        // Limpiar mensajes anteriores y añadir el inicial
                        chatbotMessagesEn.innerHTML = '';
                        addMessageToChat(chatbotMessagesEn, translations['en'].chatbotInitialMessage, 'bot');
                        chatHistoryEn.length = 0; // Limpiar historial
                        chatHistoryEn.push({ role: "model", parts: [{ text: translations['en'].chatbotInitialMessage }] }); // Añadir solo el mensaje inicial del bot
                    }


                } else {
                    // Mostrar mensaje de error específico del App Script
                    let errorMessage = translations[currentLang].invalidCode; // Mensaje por defecto
                    if (result.mensaje === 'Este código ha caducado.' || result.mensaje === 'This code has expired.') {
                        errorMessage = translations[currentLang].codeExpired;
                    } else if (result.mensaje === 'Este código ha excedido el número máximo de usos.' || result.mensaje === 'This code has exceeded the maximum number of uses.') {
                        errorMessage = translations[currentLang].usageLimitExceeded;
                    } else if (result.mensaje) {
                        errorMessage = result.mensaje; // Otros mensajes específicos del App Script
                    }
                    messageBox.textContent = errorMessage;
                    messageBox.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error validating code:', error);
                messageBox.textContent = 'Error de conexión. Por favor, inténtalo de nuevo más tarde.';
                messageBox.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
                codeInput.disabled = false;
            }
        });

        // --- Funcionalidad de pantalla completa para iframes ---
        function requestFullscreen(iframeElement) {
            if (iframeElement.requestFullscreen) {
                iframeElement.requestFullscreen();
            } else if (iframeElement.mozRequestFullScreen) { /* Firefox */
                iframeElement.mozRequestFullScreen();
            } else if (iframeElement.webkitRequestFullscreen) { /* Chrome, Safari y Opera */
                iframeElement.webkitRequestFullscreen();
            } else if (iframeElement.msRequestFullscreen) { /* IE/Edge */
                iframeElement.msRequestFullscreen();
            }
        }

        fullscreenEsMapButton.addEventListener('click', () => {
            requestFullscreen(esMapIframe);
        });

        fullscreenEnMapButton.addEventListener('click', () => {
            requestFullscreen(enMapIframe);
        });

        // --- Funcionalidad de alternar Chatbot ---
        function setupChatbot(toggleButton, panel, closeButton, messagesDiv, inputField, sendButton, chatHistoryArray, lang) {
            toggleButton.addEventListener('click', () => {
                panel.classList.toggle('active');
                if (panel.classList.contains('active')) {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight; // Desplazar hasta el final al abrir
                    inputField.focus(); // Enfocar el campo de entrada
                }
            });

            closeButton.addEventListener('click', () => {
                panel.classList.remove('active');
            });

            sendButton.addEventListener('click', () => {
                sendMessage(inputField, messagesDiv, chatHistoryArray, lang);
            });

            inputField.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendMessage(inputField, messagesDiv, chatHistoryArray, lang);
                }
            });
        }

        // Inicializar chatbots con sus respectivos historiales de chat
        if (chatbotToggleEs) {
            setupChatbot(chatbotToggleEs, chatbotPanelEs, chatbotCloseEs, chatbotMessagesEs, chatbotInputEs, chatbotSendEs, chatHistoryEs, 'es');
        }
        if (chatbotToggleEn) {
            setupChatbot(chatbotToggleEn, chatbotPanelEn, chatbotCloseEn, chatbotMessagesEn, chatbotInputEn, chatbotSendEn, chatHistoryEn, 'en');
        }

    </script>
</body>
>>>>>>> 33db35ff2b7ffc35cab66272a6c05ecca2a50b98
</html>
