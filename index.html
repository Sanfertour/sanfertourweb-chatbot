<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso a Fotoquest - Pamplona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #DC2626; /* Rojo San Fermín para el fondo */
            padding-top: 150px; /* Ajustado para el nuevo alto del encabezado fijo */
        }
        /* Estilos personalizados para los colores corporativos de San Fermín/Pamplona */
        .sap-card {
            background-color: #fef4f4; /* Rojo muy claro para el fondo de la tarjeta */
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* Sombra más pronunciada */
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid #e2e8f0; /* Borde claro */
        }
        .sap-input {
            border: 1px solid #cbd5e1; /* Borde gris medio */
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .sap-input:focus {
            outline: none;
            border-color: #ef4444; /* Borde rojo al enfocar (rojo San Fermín) */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25); /* Resplandor rojo */
        }
        .sap-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sap-button:hover {
            background-color: #dc2626; /* Rojo más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .sap-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        /* Estilos específicos del selector de idioma */
      .language-selector-container {
    position: absolute; /* Aseguramos que sea posicionado absolutamente */
    top: 4px;            /* Fija a 4px del borde superior de su padre posicionado */
    right: 4px;          /* Fija a 4px del borde derecho de su padre posicionado */
    z-index: 10;
}
        .language-toggle-button { /* Estilo específico para el botón del globo */
            background-color: #A00000; /* Rojo más oscuro para el contraste */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado (forma de píldora) */
            padding: 0.5rem; /* Relleno más pequeño */
            width: 40px; /* Ancho fijo para un círculo pequeño */
            height: 40px; /* Alto fijo para un círculo pequeño */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem; /* Icono de globo más grande */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .language-toggle-button:hover {
            background-color: #800000; /* Rojo aún más oscuro al pasar el ratón */
            transform: translateY(-1px);
        }
        .language-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0;
            min-width: 120px;
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .language-dropdown.active {
            display: flex;
        }
        .language-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        .language-item:hover {
            background-color: #fef2f2; /* Rojo claro al pasar el ratón por los elementos del menú desplegable */
        }
        .language-item img {
            width: 20px; /* Banderas más pequeñas */
            height: 15px; /* Banderas más pequeñas */
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Estilos específicos del selector de leyenda */
        .legend-selector-container {
            position: absolute; /* Cambiado de relative a absolute para posicionamiento simétrico */
            z-index: 9; /* Z-index inferior al selector de idioma */
            top: 4px; /* Simétrico al botón de idioma */
            left: 4px; /* Alineado a la izquierda */
            right: auto; /* Deshabilitar alineación a la derecha */
        }
        .legend-toggle-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 9999px; /* Completamente redondeado */
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .legend-toggle-button:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
        }
        .legend-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .legend-dropdown {
            position: absolute;
            top: 100%;
            left: 0; /* Posición a la izquierda */
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.5rem 0;
            min-width: 220px; /* Más ancho para el texto de la leyenda */
            display: none;
            flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .legend-dropdown.active {
            display: flex;
        }
        .legend-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: #333;
        }
        .legend-item i {
            font-size: 1.2rem; /* Tamaño del icono */
        }
        .map-container {
            width: 100%;
            height: 55vh; /* Ligeramente más alto para mejor visualización */
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        .map-iframe {
            width: 100%;
            height: 100%; /* Asegura que el iframe llene su contenedor */
            border: none; /* Elimina el borde por defecto del iframe */
        }
        @media (min-width: 768px) { /* Punto de interrupción md */
            .map-container {
                height: 85vh; /* Altura original para pantallas más grandes, un poco más alta */
            }
        }
        .fullscreen-button {
            background-color: #6b7280; /* Botón gris */
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .fullscreen-button:hover {
            background-color: #4b5563; /* Gris más oscuro al pasar el ratón */
        }
        .fullscreen-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .footer {
            margin-top: 2rem;
            padding: 1rem;
            text-align: center;
            color: #64748b; /* Texto gris pizarra */
            font-size: 0.875rem;
        }
        /* Nuevo estilo de fondo del encabezado */
        .header-background {
            background-image: url('https://i.imgur.com/fbid5J1.jpg'); /* Imagen de fondo actualizada */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* MODIFICACION PARA EL HEADER */
        header {
            min-height: 150px; /* Aumentar la altura mínima del encabezado */
            display: flex; /* Asegura que flexbox funcione para alinear contenido */
            align-items: center; /* Centra verticalmente el contenido */
            justify-content: center; /* Centra horizontalmente el contenido */
            padding: 0; /* Elimina el padding de Tailwind para controlarlo internamente */
        }

        /* Estilos del Chatbot */
        .chatbot-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100; /* Asegura que esté por encima de otro contenido */
        }
        .chatbot-toggle-button {
            background-color: #ef4444; /* Rojo San Fermín */
            color: #ffffff;
            border-radius: 9999px; /* Círculo completo */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .chatbot-toggle-button:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }
        .chatbot-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .chatbot-panel {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            width: 320px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(10px); /* Ligero desplazamiento inicial */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            position: absolute; /* Posición relativa al contenedor del chatbot */
            bottom: 70px; /* Encima del botón de alternar */
            right: 0;
        }
        .chatbot-panel.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .chatbot-header {
            background-color: #ef4444;
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .chatbot-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #f0f2f5; /* Gris claro para el fondo del chat */
            border-bottom: 1px solid #e2e8f0;
            display: flex; /* Usar flexbox para los mensajes */
            flex-direction: column; /* Apilar mensajes verticalmente */
        }
        .chatbot-input-area {
            display: flex;
            padding: 0.75rem 1rem;
            border-top: 1px solid #e2e8f0;
        }
        .chatbot-input {
            flex-grow: 1;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }
        .chatbot-send-button {
            background-color: #ef4444;
            color: #ffffff;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
        }
        .chatbot-send-button:hover {
            background-color: #dc2626;
        }
        .chatbot-message {
            margin-bottom: 0.5rem;
            padding: 0.6rem 0.8rem;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word; /* Asegura que las palabras largas se ajusten */
        }
        .chatbot-message.user {
            background-color: #e0f2fe; /* Azul claro para los mensajes del usuario */
            align-self: flex-end;
            margin-left: auto;
        }
        .chatbot-message.bot {
            background-color: #e2e8f0; /* Gris claro para los mensajes del bot */
            align-self: flex-start;
            margin-right: auto;
        }
        .chatbot-loading-dots {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }
        .chatbot-loading-dots:nth-child(1) { animation-delay: -0.32s; }
        .chatbot-loading-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* AI Photo Guide Styles */
        .ai-photo-container {
            position: fixed;
            bottom: 20px; /* Same bottom as chatbot */
            right: 96px; /* 20px (chatbot right) + 60px (chatbot width) + 16px (gap) = 96px */
            z-index: 100; /* Same z-index as chatbot */
        }
        .ai-photo-toggle-button {
            background-color: #3b82f6; /* Blue for contrast */
            color: #ffffff;
            border-radius: 9999px; /* Full circle */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            cursor: pointer;
        }
        .ai-photo-toggle-button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .ai-photo-toggle-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        .ai-photo-panel {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            width: 320px;
            height: 500px; /* Increased height for content */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(10px); /* Slight initial displacement */
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s ease-out;
            position: absolute;
            bottom: 70px; /* Above the toggle button, aligned with chatbot panel */
            right: 0;
        }
        .ai-photo-panel.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .ai-photo-header {
            background-color: #3b82f6; /* Blue for header */
            color: #ffffff;
            padding: 0.75rem 1rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .ai-photo-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column;
        }
        .camera-preview-container {
            width: 100%;
            height: 180px; /* Fixed height for camera preview */
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video#camera-preview {
            max-width: 100%;
            max-height: 100%;
        }
        img#captured-image {
            max-width: 100%;
            max-height: 100%;
        }
        #ai-response-area {
            min-height: 80px; /* Minimum height for response area */
            max-height: 120px; /* Maximum height for response area */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

 <header class="fixed top-0 left-0 w-full shadow-md z-20 header-background">
    <div class="flex items-center max-w-4xl w-full p-4">
        <a href="/" class="flex items-center"> <img id="header-logo" src="https://i.imgur.com/zN8CIl3.jpg" alt="Sanfertour Logo" class="h-12 w-auto mr-4">
            <h1 id="header-title" class="text-3xl font-bold text-red-600 tracking-tight">Sanfertour</h1>
        </a>
    </div>
</header>

    <div id="app-container" class="relative w-full max-w-4xl mx-auto flex flex-col flex-grow p-4">

        <div class="language-selector-container absolute top-4 right-4">
            <button id="language-toggle" class="language-toggle-button">
                <i class="fas fa-globe text-white"></i>
            </button>
            <div id="language-dropdown" class="language-dropdown">
                <div class="language-item" data-lang="es">
                    <img src="https://flagcdn.com/es.svg" alt="Spanish Flag">
                    <span>Español</span>
                </div>
                <div class="language-item" data-lang="en">
                    <img src="https://flagcdn.com/gb.svg" alt="English Flag">
                    <span>English</span>
                </div>
                <div class="language-item" data-lang="fr">
                    <img src="https://flagcdn.com/fr.svg" alt="French Flag">
                    <span>Français</span>
                </div>
                <div class="language-item" data-lang="de">
                    <img src="https://flagcdn.com/de.svg" alt="German Flag">
                    <span>Deutsch</span>
                </div>
                <div class="language-item" data-lang="it">
                    <img src="https://flagcdn.com/it.svg" alt="Italian Flag">
                    <span>Italiano</span>
                </div>
                <div class="language-item" data-lang="zh">
                    <img src="https://flagcdn.com/cn.svg" alt="Chinese Flag">
                    <span>中文</span>
                </div>
                <div class="language-item" data-lang="eu">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Flag_of_the_Basque_Country_by_Sabino_Arana.svg/220px-Flag_of_the_Basque_Country_by_Sabino_Arana.svg.png" alt="Basque Flag">
                    <span>Euskera</span>
                </div>
                <div class="language-item" data-lang="ja">
                    <img src="https://flagcdn.com/jp.svg" alt="Japanese Flag">
                    <span>日本語</span>
                </div>
                <div class="language-item" data-lang="pt">
                    <img src="https://flagcdn.com/pt.svg" alt="Portuguese Flag">
                    <span>Português</span>
                </div>
            </div>
        </div>

        <section id="code-entry-section" class="flex flex-col items-center justify-center flex-grow">
            <div class="sap-card text-center">
                <p id="welcome-instruction" class="text-gray-700 text-lg mb-4 font-semibold"></p>
                
                <h1 id="form-title" class="text-4xl font-bold text-gray-800 mb-4"></h1>
                
                <p id="form-description" class="text-xl text-gray-600 mb-8"></p>
                <form id="code-form" class="space-y-6">
                    <div>
                        <label for="code-input" id="code-label" class="block text-left text-gray-700 text-sm font-medium mb-2">Código de Acceso</label>
                        <input type="text" id="code-input" class="sap-input" placeholder="Introduce tu código aquí" required>
                    </div>
                    <button type="submit" id="submit-button" class="sap-button w-full">Acceder</button>
                    <div id="message-box" class="text-red-600 text-sm mt-4 hidden"></div>
                    <div id="loading-indicator" class="hidden flex items-center justify-center mt-4 text-red-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i> <span id="loading-text">Validando código...</span>
                    </div>
                </form>
            </div>
        </section>

        <section id="es-map-section" class="hidden flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-es"></h2>
                <p class="text-gray-700 mb-4" id="map-description-es"></p>
                
                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-es" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-es" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-es">Gastroguía y Ocio Nocturno</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-es">Audioguía</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-es-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Pantalla Completa
                </button>
                <div class="map-container">
                    <iframe id="es-map-iframe" class="map-iframe" src="https://illustrious-sherbet-a1b6fc.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-es" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-es" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-es">Chatbot de Ayuda</span>
                        <button id="chatbot-close-es" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-es" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-es" class="chatbot-input" placeholder="Escribe tu mensaje...">
                        <button id="chatbot-send-es" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="en-map-section" class="hidden flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-en"></h2>
                <p class="text-gray-700 mb-4" id="map-description-en"></p>

                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-en" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-en" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-en">Gastronomy and Nightlife Guide</span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-en">Audio Guide</span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-en-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> Fullscreen
                </button>
                <div class="map-container">
                    <iframe id="en-map-iframe" class="map-iframe" src="https://68359b9a0a454de624224515--scintillating-capybara-21e569.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-en" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-en" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-en">Help Chatbot</span>
                        <button id="chatbot-close-en" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div id="chatbot-messages-en" class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-en" class="chatbot-input" placeholder="Type your message...">
                        <button id="chatbot-send-en" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="fr-map-section" class="hidden flex-col items-center justify-center w-full p-4">
            <div class="sap-card w-full max-w-4xl text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4" id="map-title-fr"></h2>
                <p class="text-gray-700 mb-4" id="map-description-fr"></p>

                <div class="legend-selector-container absolute">
                    <button id="legend-toggle-fr" class="legend-toggle-button">
                        <i class="fas fa-info text-white"></i> </button>
                    <div id="legend-dropdown-fr" class="legend-dropdown">
                        <div class="legend-item">
                            <i class="fas fa-map-pin text-blue-600"></i>
                            <span id="legend-gastro-fr"></span>
                        </div>
                        <div class="legend-item">
                            <i class="fas fa-location-dot text-red-600"></i> <span id="legend-audioguia-fr"></span>
                        </div>
                    </div>
                </div>

                <button id="fullscreen-fr-map" class="fullscreen-button mb-4">
                    <i class="fas fa-expand mr-2"></i> </button>
                <div class="map-container">
                    <iframe id="fr-map-iframe" class="map-iframe" src="https://dashing-crisp-97b881.netlify.app/" allowfullscreen allow="geolocation"></iframe>
                </div>
            </div>
            <div class="chatbot-container">
                <button id="chatbot-toggle-fr" class="chatbot-toggle-button">
                    <i class="fas fa-comments"></i>
                </button>
                <div id="chatbot-panel-fr" class="chatbot-panel">
                    <div class="chatbot-header">
                        <span id="chatbot-header-text-fr"></span>
                        <button id="chatbot-close-fr" class="text-white text-xl leading-none">&times;</button>
                    </div>
                    <div class="chatbot-messages flex flex-col">
                        <div class="chatbot-message bot"></div> </div>
                    <div class="chatbot-input-area">
                        <input type="text" id="chatbot-input-fr" class="chatbot-input" placeholder="">
                        <button id="chatbot-send-fr" class="chatbot-send-button">Enviar</button>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <div class="ai-photo-container">
        <button id="ai-photo-toggle" class="ai-photo-toggle-button">
            <i class="fas fa-camera"></i>
        </button>
        <div id="ai-photo-panel" class="ai-photo-panel">
            <div class="ai-photo-header">
                <span id="ai-photo-header-text-es">Foto Guía IA</span>
                <button id="ai-photo-close" class="text-white text-xl leading-none">&times;</button>
            </div>
            <div class="ai-photo-content">
                <div id="ai-photo-messages" class="ai-photo-messages">
                    <p id="ai-photo-initial-message" class="text-gray-700"></p>
                </div>
                <div class="camera-preview-container">
                    <video id="camera-preview" class="w-full h-full object-cover rounded-lg shadow-inner" autoplay playsinline></video>
                    <canvas id="photo-canvas" class="hidden"></canvas>
                    <img id="captured-image" class="hidden w-full h-full object-contain rounded-lg shadow-md" alt="Captured Image">
                </div>
                <div class="flex flex-col items-center gap-2 mt-4">
                    <button id="capture-photo-button" class="sap-button w-full"><i class="fas fa-camera mr-2"></i> Tomar Foto</button>
                    <button id="retake-photo-button" class="sap-button bg-gray-500 hover:bg-gray-600 w-full hidden"><i class="fas fa-redo mr-2"></i> Volver a Tomar</button>
                </div>
                <div id="geolocation-info" class="text-sm text-gray-600 mt-4 text-center">
                    <p id="geo-status"></p>
                    <p id="geo-coords"></p>
                </div>
                <div id="ai-response-area" class="mt-4 p-3 bg-gray-100 rounded-lg text-gray-800 text-sm overflow-y-auto max-h-40">
                    <p id="ai-response-text"></p>
                    <div id="ai-loading-indicator" class="hidden flex items-center justify-center mt-2 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i> <span id="ai-loading-text">Analizando imagen...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <footer class="footer">
        <p id="copyright-text">&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado.</p>
    </footer>

    <script>
        // --- Gestión de idiomas ---
        const translations = {
            es: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // Este texto ya no se usa visualmente en este punto
                formTitle: "Bienvenido a la primera experiencia GoTour de Pamplona", // Nuevo título principal
                formDescription: "La ciudad en tus auriculares, a tu ritmo, a tu manera...", // Nuevo subtítulo
                codeLabel: "Código de Acceso",
                codeInputPlaceholder: "Introduce tu código aquí",
                submitButton: "Acceder",
                invalidCode: "Código inválido. Por favor, inténtalo de nuevo.",
                codeExpired: "El código ha caducado. Por favor, contacta con el administrador.",
                usageLimitExceeded: "Este código ha excedido su límite de usos. Por favor, contacta con el administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bienvenido a Sanfertour", // Texto actualizado
                mapDescription: "La única experiencia Gotour: a tu manera y a tu ritmo.", // Texto actualizado
                legendToggle: "Leyenda del Mapa",
                legendGastro: "Gastroguía y Ocio Nocturno",
                legendAudioguia: "Audioguía",
                fullscreenButton: "Pantalla Completa",
                chatbotHeaderText: "Chatbot de Ayuda",
                chatbotInputPlaceholder: "Escribe tu mensaje...",
                chatbotInitialMessage: "¡Hola! Soy tu guía de Sanfertour. Pregúntame sobre los lugares de interés, historia, gastronomía y cultura de Pamplona. ✨",
                chatbotErrorMessage: "Lo siento, hubo un error al obtener la respuesta. Por favor, inténtalo de nuevo.",
                aiPhotoHeaderText: "Foto Guía IA",
                aiPhotoInitialMessage: "Toma una foto del monumento para obtener información guiada por IA.",
                capturePhotoButton: "Tomar Foto",
                retakePhotoButton: "Volver a Tomar",
                geoStatusLoading: "Obteniendo ubicación...",
                geoStatusError: "No se pudo obtener la ubicación. Por favor, habilita los servicios de ubicación.",
                analyzingImage: "Analizando imagen...",
                aiResponseError: "Lo siento, hubo un error al analizar la imagen. Por favor, inténtalo de nuevo.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos los derechos reservados. Prohibida su descarga, reproducción o uso no autorizado."
            },
            en: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "", // This text is no longer used visually at this point
                formTitle: "Welcome to Pamplona's First GoTour Experience", // New main title
                formDescription: "The city in your headphones, at your pace, your way...", // New subtitle
                codeLabel: "Access Code",
                codeInputPlaceholder: "Enter your code here",
                submitButton: "Access",
                invalidCode: "Invalid code. Please try again.",
                codeExpired: "The code has expired. Please contact the administrator.",
                usageLimitExceeded: "This code has exceeded its usage limit. Please contact the administrator.",
                loadingText: "Validating code...",
                mapTitle: "Welcome to Sanfertour", // Updated text
                mapDescription: "The unique Gotour experience: your way, your pace.", // Updated text
                legendToggle: "Map Legend",
                legendGastro: "Gastronomy and Nightlife Guide",
                legendAudioguia: "Audio Guide",
                fullscreenButton: "Fullscreen",
                chatbotHeaderText: "Help Chatbot",
                chatbotInputPlaceholder: "Type your message...",
                chatbotInitialMessage: "Hi! I'm your Sanfertour guide. Ask me about Pamplona's sights, history, gastronomy, and culture. ✨",
                chatbotErrorMessage: "Sorry, there was an error getting the response. Please try again.",
                aiPhotoHeaderText: "AI Photo Guide",
                aiPhotoInitialMessage: "Take a photo of the monument to get AI-guided information.",
                capturePhotoButton: "Take Photo",
                retakePhotoButton: "Retake Photo",
                geoStatusLoading: "Getting location...",
                geoStatusError: "Could not get location. Please enable location services.",
                analyzingImage: "Analyzing image...",
                aiResponseError: "Sorry, there was an error analyzing the image. Please try again.",
                copyright: "&copy; 2025 Fotoquest Pamplona. All rights reserved. Downloading, reproduction, or unauthorized use is prohibited."
            },
            fr: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bienvenue à la première expérience GoTour de Pampelune",
                formDescription: "La ville dans vos écouteurs, à votre rythme, à votre manière...",
                codeLabel: "Code d'accès",
                codeInputPlaceholder: "Entrez votre code ici",
                submitButton: "Accéder",
                invalidCode: "Code invalide. Veuillez réessayer.",
                codeExpired: "Le code a expiré. Veuillez contacter l'administrateur.",
                usageLimitExceeded: "Ce code a dépassé sa limite d'utilisation. Veuillez contacter l'administrateur.",
                loadingText: "Validation du code...",
                mapTitle: "Bienvenue à Sanfertour", // Texto actualizado para francés
                mapDescription: "L'expérience Gotour unique : à votre manière et à votre rythme.", // Texto actualizado para francés
                legendToggle: "Légende de la carte",
                legendGastro: "Guide gastronomique et vie nocturne",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Plein écran",
                chatbotHeaderText: "Chatbot d'aide",
                chatbotInputPlaceholder: "Écrivez votre message...",
                chatbotInitialMessage: "Bonjour ! Je suis votre guide Sanfertour. Posez-moi des questions sur les sites, l'histoire, la gastronomie et la culture de Pampelune. ✨",
                chatbotErrorMessage: "Désolé, une erreur s'est produite lors de la récupération de la réponse. Veuillez réessayer.",
                aiPhotoHeaderText: "Guide Photo IA",
                aiPhotoInitialMessage: "Prenez une photo du monument pour obtenir des informations guidées par l'IA.",
                capturePhotoButton: "Prendre une photo",
                retakePhotoButton: "Reprendre la photo",
                geoStatusLoading: "Obtention de la localisation...",
                geoStatusError: "Impossible d'obtenir la localisation. Veuillez activer les services de localisation.",
                analyzingImage: "Analyse de l'image...",
                aiResponseError: "Désolé, une erreur s'est produite lors de l'analyse de l'image. Veuillez réessayer.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tous droits réservés. Téléchargement, reproduction ou utilisation non autorisée interdits."
            },
            de: {
                headerLogoAlt: "Sanfertour Logo",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Willkommen zum ersten GoTour Erlebnis in Pamplona",
                formDescription: "Die Stadt in Ihren Kopfhörern, in Ihrem Tempo, auf Ihre Weise...",
                codeLabel: "Zugangscode",
                codeInputPlaceholder: "Geben Sie hier Ihren Code ein",
                submitButton: "Zugang",
                invalidCode: "Ungültiger Code. Bitte versuchen Sie es erneut.",
                codeExpired: "Der Code ist abgelaufen. Bitte kontaktieren Sie den Administrator.",
                usageLimitExceeded: "Dieser Code hat sein Nutzungslimit überschritten. Bitte kontaktieren Sie den Administrator.",
                loadingText: "Code wird überprüft...",
                mapTitle: "Willkommen bei Sanfertour",
                mapDescription: "Das einzigartige Gotour-Erlebnis: auf Ihre Weise, in Ihrem Tempo.",
                legendToggle: "Kartenlegende",
                legendGastro: "Gastronomie- und Nachtlebenführer",
                legendAudioguia: "Audioguide",
                fullscreenButton: "Vollbild",
                chatbotHeaderText: "Hilfe-Chatbot",
                chatbotInputPlaceholder: "Geben Sie Ihre Nachricht ein...",
                chatbotInitialMessage: "Hallo! Ich bin Ihr Sanfertour-Guide. Fragen Sie mich nach den Sehenswürdigkeiten, der Geschichte, der Gastronomie und der Kultur Pamplonas. ✨",
                chatbotErrorMessage: "Entschuldigung, beim Abrufen der Antwort ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
                aiPhotoHeaderText: "KI-Fotoführer",
                aiPhotoInitialMessage: "Machen Sie ein Foto des Denkmals, um KI-geführte Informationen zu erhalten.",
                capturePhotoButton: "Foto aufnehmen",
                retakePhotoButton: "Foto erneut aufnehmen",
                geoStatusLoading: "Standort wird abgerufen...",
                geoStatusError: "Standort konnte nicht abgerufen werden. Bitte aktivieren Sie die Standortdienste.",
                analyzingImage: "Bild wird analysiert...",
                aiResponseError: "Entschuldigung, beim Analysieren des Bildes ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Alle Rechte vorbehalten. Herunterladen, Reproduktion oder unbefugte Nutzung ist untersagt."
            },
            it: {
                headerLogoAlt: "Logo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Benvenuti alla prima esperienza GoTour di Pamplona",
                formDescription: "La città nelle tue cuffie, al tuo ritmo, a modo tuo...",
                codeLabel: "Codice di Accesso",
                codeInputPlaceholder: "Inserisci il tuo codice qui",
                submitButton: "Accedi",
                invalidCode: "Codice non valido. Si prega di riprovare.",
                codeExpired: "Il codice è scaduto. Si prega di contattare l'amministratore.",
                usageLimitExceeded: "Questo codice ha superato il limite di utilizzi. Si prega di contattare l'amministratore.",
                loadingText: "Validazione codice...",
                mapTitle: "Benvenuti a Sanfertour",
                mapDescription: "L'esperienza Gotour unica: a modo tuo, al tuo ritmo.",
                legendToggle: "Legenda della Mappa",
                legendGastro: "Guida gastronomica e vita notturna",
                legendAudioguida: "Audioguida",
                fullscreenButton: "Schermo intero",
                chatbotHeaderText: "Chatbot di aiuto",
                chatbotInputPlaceholder: "Scrivi il tuo messaggio...",
                chatbotInitialMessage: "Ciao! Sono la tua guida Sanfertour. Chiedimi informazioni sui luoghi d'interesse, la storia, la gastronomia e la cultura di Pamplona. ✨",
                chatbotErrorMessage: "Siamo spiacenti, si è verificato un errore durante il recupero della risposta. Riprova.",
                aiPhotoHeaderText: "Guida fotografica IA",
                aiPhotoInitialMessage: "Scatta una foto del monumento per ottenere informazioni guidate dall'IA.",
                capturePhotoButton: "Scatta foto",
                retakePhotoButton: "Riscatti foto",
                geoStatusLoading: "Recupero posizione...",
                geoStatusError: "Impossibile ottenere la posizione. Si prega di abilitare i servizi di localizzazione.",
                analyzingImage: "Analizzando l'immagine...",
                aiResponseError: "Siamo spiacenti, si è verificato un errore durante l'analisi dell'immagine. Riprova.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Tutti i diritti riservati. Download, riproduzione o utilizzo non autorizzato sono proibiti."
            },
            zh: {
                headerLogoAlt: "Sanfertour 标志",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "欢迎来到潘普洛纳的首次GoTour体验",
                formDescription: "城市在你的耳机里，按照你的节奏，你的方式...",
                codeLabel: "访问代码",
                codeInputPlaceholder: "在此输入您的代码",
                submitButton: "访问",
                invalidCode: "代码无效。请再试一次。",
                codeExpired: "代码已过期。请联系管理员。",
                usageLimitExceeded: "此代码已超出使用限制。请联系管理员。",
                loadingText: "正在验证代码...",
                mapTitle: "欢迎来到Sanfertour",
                mapDescription: "独特的Gotour体验：随心所欲，按自己的节奏。",
                legendToggle: "地图图例",
                legendGastro: "美食和夜生活指南",
                legendAudioguia: "语音导览",
                fullscreenButton: "全屏",
                chatbotHeaderText: "帮助聊天机器人",
                chatbotInputPlaceholder: "输入您的消息...",
                chatbotInitialMessage: "你好！我是你的Sanfertour向导。向我询问潘普洛纳的景点、历史、美食和文化。✨",
                chatbotErrorMessage: "抱歉，获取回复时出错。请重试。",
                aiPhotoHeaderText: "AI照片指南",
                aiPhotoInitialMessage: "拍摄纪念碑的照片以获取AI指导信息。",
                capturePhotoButton: "拍照",
                retakePhotoButton: "重拍",
                geoStatusLoading: "正在获取位置...",
                geoStatusError: "无法获取位置。请启用位置服务。",
                analyzingImage: "正在分析图像...",
                aiResponseError: "抱歉，分析图像时出错。请重试。",
                copyright: "&copy; 2025 Fotoquest Pamplona. 保留所有权利。禁止下载、复制或未经授权的使用。"
            },
            eu: {
                headerLogoAlt: "Sanfertour Logotipoa",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Ongi etorri Iruñeko lehen GoTour esperientziara",
                formDescription: "Hiria zure aurikularretan, zure erritmoan, zure moduan...",
                codeLabel: "Sarbide Kodea",
                codeInputPlaceholder: "Sartu zure kodea hemen",
                submitButton: "Sartu",
                invalidCode: "Kode baliogabea. Mesedez, saiatu berriro.",
                codeExpired: "Kodea iraungi da. Mesedez, jarri harremanetan administratzailearekin.",
                usageLimitExceeded: "Kode honek erabilera muga gainditu du. Mesedez, jarri harremanetan administratzailearekin.",
                loadingText: "Kodea balioztatzen...",
                mapTitle: "Ongi etorri Sanfertour-era",
                mapDescription: "Gotour esperientzia bakarra: zure moduan, zure erritmoan.",
                legendToggle: "Maparen legenda",
                legendGastro: "Gastrogida eta Gaueko Aisia",
                legendAudioguia: "Audiogida",
                fullscreenButton: "Pantaila osoa",
                chatbotHeaderText: "Laguntza-chatbot-a",
                chatbotInputPlaceholder: "Idatzi zure mezua...",
                chatbotInitialMessage: "Kaixo! Zure Sanfertour-eko gida naiz. Galdetu Iruñeko interesgune, historia, gastronomia eta kulturari buruz. ✨",
                chatbotErrorMessage: "Barkatu, akats bat gertatu da erantzuna lortzean. Mesedez, saiatu berriro.",
                aiPhotoHeaderText: "AI Argazki Gida",
                aiPhotoInitialMessage: "Hartu monumentuaren argazki bat AI bidez gidatutako informazioa lortzeko.",
                capturePhotoButton: "Argazkia atera",
                retakePhotoButton: "Berriro atera",
                geoStatusLoading: "Kokapena lortzen...",
                geoStatusError: "Ezin izan da kokapena lortu. Mesedez, gaitu kokapen zerbitzuak.",
                analyzingImage: "Irudia analizatzen...",
                aiResponseError: "Barkatu, akats bat gertatu da irudia analizatzean. Mesedez, saiatu berriro.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Eskubide guztiak erreserbatuta. Debekatuta dago deskargatzea, erreproduzitzea edo baimenik gabe erabiltzea."
            },
            ja: {
                headerLogoAlt: "サンフェルツアーロゴ",
                headerTitle: "サンフェルツアー",
                welcomeInstruction: "",
                formTitle: "パンプローナ初のGoTour体験へようこそ",
                formDescription: "あなたのヘッドフォンで街を、あなたのペースで、あなたの方法で...",
                codeLabel: "アクセスコード",
                codeInputPlaceholder: "ここにコードを入力してください",
                submitButton: "アクセス",
                invalidCode: "無効なコードです。もう一度お試しください。",
                codeExpired: "コードの有効期限が切れました。管理者にお問い合わせください。",
                usageLimitExceeded: "このコードは使用制限を超えました。管理者にお問い合わせください。",
                loadingText: "コードを検証中...",
                mapTitle: "サンフェルツアーへようこそ",
                mapDescription: "ユニークなGoTour体験：あなたの方法で、あなたのペースで。",
                legendToggle: "地図凡例",
                legendGastro: "美食＆ナイトライフガイド",
                legendAudioguia: "オーディオガイド",
                fullscreenButton: "フルスクリーン",
                chatbotHeaderText: "ヘルプチャットボット",
                chatbotInputPlaceholder: "メッセージを入力してください...",
                chatbotInitialMessage: "こんにちは！サンフェルツアーガイドです。パンプローナの見どころ、歴史、美食、文化についてお尋ねください。✨",
                chatbotErrorMessage: "申し訳ありません、応答の取得中にエラーが発生しました。もう一度お試しください。",
                aiPhotoHeaderText: "AI写真ガイド",
                aiPhotoInitialMessage: "記念碑の写真を撮って、AIが案内する情報を入手してください。",
                capturePhotoButton: "写真を撮る",
                retakePhotoButton: "撮り直す",
                geoStatusLoading: "位置情報を取得中...",
                geoStatusError: "位置情報を取得できませんでした。位置情報サービスを有効にしてください。",
                analyzingImage: "画像を分析中...",
                aiResponseError: "申し訳ありません、画像の分析中にエラーが発生しました。もう一度お試しください。",
                copyright: "&copy; 2025 Fotoquest Pamplona. 全著作権所有。ダウンロード、複製、無断使用は禁止されています。"
            },
            pt: {
                headerLogoAlt: "Logotipo Sanfertour",
                headerTitle: "Sanfertour",
                welcomeInstruction: "",
                formTitle: "Bem-vindo à primeira experiência GoTour de Pamplona",
                formDescription: "A cidade nos seus fones, no seu ritmo, do seu jeito...",
                codeLabel: "Código de Acesso",
                codeInputPlaceholder: "Digite seu código aqui",
                submitButton: "Acessar",
                invalidCode: "Código inválido. Por favor, tente novamente.",
                codeExpired: "O código expirou. Por favor, entre em contato com o administrador.",
                usageLimitExceeded: "Este código excedeu seu limite de usos. Por favor, entre em contato com o administrador.",
                loadingText: "Validando código...",
                mapTitle: "Bem-vindo ao Sanfertour",
                mapDescription: "A experiência Gotour única: do seu jeito, no seu ritmo.",
                legendToggle: "Legenda do Mapa",
                legendGastro: "Guia de Gastronomia e Vida Noturna",
                legendAudioguia: "Audioguia",
                fullscreenButton: "Tela Cheia",
                chatbotHeaderText: "Chatbot de Ajuda",
                chatbotInputPlaceholder: "Escreva sua mensagem...",
                chatbotInitialMessage: "Olá! Sou seu guia Sanfertour. Pergunte-me sobre os pontos turísticos, história, gastronomia e cultura de Pamplona. ✨",
                chatbotErrorMessage: "Desculpe, houve um erro ao obter a resposta. Por favor, tente novamente.",
                aiPhotoHeaderText: "Guia de Fotos IA",
                aiPhotoInitialMessage: "Tire uma foto do monumento para obter informações guiadas por IA.",
                capturePhotoButton: "Tirar Foto",
                retakePhotoButton: "Retirar Foto",
                geoStatusLoading: "Obtendo localização...",
                geoStatusError: "Não foi possível obter a localização. Por favor, ative os serviços de localização.",
                analyzingImage: "Analisando imagem...",
                aiResponseError: "Desculpe, houve um erro ao analisar a imagem. Por favor, tente novamente.",
                copyright: "&copy; 2025 Fotoquest Pamplona. Todos os direitos reservados. Proibido download, reprodução ou uso não autorizado."
            }
        };

        let currentLang = 'es'; // Idioma por defecto

        // --- Referencias a elementos DOM ---
        const languageToggleButton = document.getElementById('language-toggle');
        const languageDropdown = document.getElementById('language-dropdown');
        const languageItems = document.querySelectorAll('.language-item');

        const headerLogo = document.getElementById('header-logo');
        const headerTitle = document.getElementById('header-title');
        const welcomeInstruction = document.getElementById('welcome-instruction');
        const formTitle = document.getElementById('form-title');
        const formDescription = document.getElementById('form-description');
        const codeLabel = document.getElementById('code-label');
        const codeInput = document.getElementById('code-input');
        const submitButton = document.getElementById('submit-button');
        const messageBox = document.getElementById('message-box');
        const loadingIndicator = document.getElementById('loading-indicator');
        const loadingText = document.getElementById('loading-text');
        const copyrightText = document.getElementById('copyright-text');

        const codeEntrySection = document.getElementById('code-entry-section');
        const esMapSection = document.getElementById('es-map-section');
        const enMapSection = document.getElementById('en-map-section');
        const frMapSection = document.getElementById('fr-map-section'); // Nuevo para francés
        const esMapIframe = document.getElementById('es-map-iframe');
        const enMapIframe = document.getElementById('en-map-iframe');
        const frMapIframe = document.getElementById('fr-map-iframe'); // Nuevo para francés
        const fullscreenEsMapButton = document.getElementById('fullscreen-es-map');
        const fullscreenEnMapButton = document.getElementById('fullscreen-en-map');
        const fullscreenFrMapButton = document.getElementById('fullscreen-fr-map'); // Nuevo para francés

        // Elementos de leyenda
        const legendToggleEs = document.getElementById('legend-toggle-es');
        const legendDropdownEs = document.getElementById('legend-dropdown-es');
        const legendToggleEn = document.getElementById('legend-toggle-en');
        const legendDropdownEn = document.getElementById('legend-dropdown-en');
        const legendToggleFr = document.getElementById('legend-toggle-fr'); // Nuevo para francés
        const legendDropdownFr = document.getElementById('legend-dropdown-fr'); // Nuevo para francés


        // Elementos del Chatbot en español
        const chatbotToggleEs = document.getElementById('chatbot-toggle-es');
        const chatbotPanelEs = document.getElementById('chatbot-panel-es');
        const chatbotCloseEs = document.getElementById('chatbot-close-es');
        const chatbotHeaderTextEs = document.getElementById('chatbot-header-text-es');
        const chatbotMessagesEs = document.getElementById('chatbot-messages-es');
        const chatbotInputEs = document.getElementById('chatbot-input-es');
        const chatbotSendEs = document.getElementById('chatbot-send-es');
        // Historial de chat global para todos los idiomas
        const chatHistories = {
            es: [],
            en: [],
            fr: [], // Inicializar historial para francés
            de: [],
            it: [],
            zh: [],
            eu: [],
            ja: [],
            pt: []
        };
        
        // Elementos del Chatbot en inglés
        const chatbotToggleEn = document.getElementById('chatbot-toggle-en');
        const chatbotPanelEn = document.getElementById('chatbot-panel-en');
        const chatbotCloseEn = document.getElementById('chatbot-close-en');
        const chatbotHeaderTextEn = document.getElementById('chatbot-header-text-en');
        const chatbotMessagesEn = document.getElementById('chatbot-messages-en');
        const chatbotInputEn = document.getElementById('chatbot-input-en');
        const chatbotSendEn = document.getElementById('chatbot-send-en');

        // Elementos del Chatbot en francés
        const chatbotToggleFr = document.getElementById('chatbot-toggle-fr');
        const chatbotPanelFr = document.getElementById('chatbot-panel-fr');
        const chatbotCloseFr = document.getElementById('chatbot-close-fr');
        const chatbotHeaderTextFr = document.getElementById('chatbot-header-text-fr');
        const chatbotMessagesFr = document.getElementById('chatbot-messages-fr');
        const chatbotInputFr = document.getElementById('chatbot-input-fr');
        const chatbotSendFr = document.getElementById('chatbot-send-fr');

        // Elementos de la Foto Guía IA
        const aiPhotoToggle = document.getElementById('ai-photo-toggle');
        const aiPhotoPanel = document.getElementById('ai-photo-panel');
        const aiPhotoClose = document.getElementById('ai-photo-close');
        const aiPhotoHeaderText = document.getElementById('ai-photo-header-text-es'); // Assuming Spanish for now, will handle translations
        const aiPhotoMessages = document.getElementById('ai-photo-messages');
        const aiPhotoInitialMessage = document.getElementById('ai-photo-initial-message');
        const cameraPreview = document.getElementById('camera-preview');
        const photoCanvas = document.getElementById('photo-canvas');
        const capturedImage = document.getElementById('captured-image');
        const capturePhotoButton = document.getElementById('capture-photo-button');
        const retakePhotoButton = document.getElementById('retake-photo-button');
        const geolocationInfo = document.getElementById('geolocation-info');
        const geoStatus = document.getElementById('geo-status');
        const geoCoords = document.getElementById('geo-coords');
        const aiResponseArea = document.getElementById('ai-response-area');
        const aiResponseText = document.getElementById('ai-response-text');
        const aiLoadingIndicator = document.getElementById('ai-loading-indicator');
        const aiLoadingText = document.getElementById('ai-loading-text');

        let currentStream; // To store camera stream
        let currentLatitude, currentLongitude; // To store geolocation


        // --- Funciones de utilidad ---
        function updateContent(lang) {
            const t = translations[lang];

            // Encabezado
            headerLogo.alt = t.headerLogoAlt;
            headerTitle.textContent = t.headerTitle;

            // Formulario
            welcomeInstruction.textContent = t.welcomeInstruction;
            formTitle.textContent = t.formTitle;
            formDescription.textContent = t.formDescription;
            codeLabel.textContent = t.codeLabel;
            codeInput.placeholder = t.codeInputPlaceholder;
            submitButton.textContent = t.submitButton;
            loadingText.textContent = t.loadingText;

            // Pie de página
            copyrightText.innerHTML = t.copyright;

            // Actualizar textos de leyenda y botón de pantalla completa para el idioma activo
            if (lang === 'es') {
                document.getElementById('map-title-es').textContent = t.mapTitle;
                document.getElementById('map-description-es').textContent = t.mapDescription;
                document.getElementById('legend-gastro-es').textContent = t.legendGastro;
                document.getElementById('legend-audioguia-es').textContent = t.legendAudioguia;
                fullscreenEsMapButton.querySelector('i').nextSibling.textContent = ' ' + t.fullscreenButton;
                chatbotHeaderTextEs.textContent = t.chatbotHeaderText;
                chatbotInputEs.placeholder = t.chatbotInputPlaceholder;
                chatbotSendEs.textContent = "Enviar"; // Mantener "Enviar" como en el original, o cambiar si se desea "Send"
            } else if (lang === 'en') {
                document.getElementById('map-title-en').textContent = t.mapTitle;
                document.getElementById('map-description-en').textContent = t.mapDescription;
                document.getElementById('legend-gastro-en').textContent = t.legendGastro;
                document.getElementById('legend-audioguia-en').textContent = t.legendAudioguia;
                fullscreenEnMapButton.querySelector('i').nextSibling.textContent = ' ' + t.fullscreenButton;
                chatbotHeaderTextEn.textContent = t.chatbotHeaderText;
                chatbotInputEn.placeholder = t.chatbotInputPlaceholder;
                chatbotSendEn.textContent = "Send"; // Cambiado a "Send" para inglés
            } else if (lang === 'fr') {
                document.getElementById('map-title-fr').textContent = t.mapTitle;
                document.getElementById('map-description-fr').textContent = t.mapDescription;
                document.getElementById('legend-gastro-fr').textContent = t.legendGastro;
                document.getElementById('legend-audioguia-fr').textContent = t.legendAudioguia;
                fullscreenFrMapButton.querySelector('i').nextSibling.textContent = ' ' + t.fullscreenButton;
                chatbotHeaderTextFr.textContent = t.chatbotHeaderText;
                chatbotInputFr.placeholder = t.chatbotInputPlaceholder;
                chatbotSendFr.textContent = "Envoyer"; // Cambiado a "Envoyer" para francés
            }
            // Añadir más bloques else if para otros idiomas si tienen elementos específicos en el HTML

            // Update AI Photo Guide texts
            if (aiPhotoHeaderText) aiPhotoHeaderText.textContent = t.aiPhotoHeaderText;
            if (aiPhotoInitialMessage) aiPhotoInitialMessage.textContent = t.aiPhotoInitialMessage;
            if (capturePhotoButton) capturePhotoButton.querySelector('i').nextSibling.textContent = ' ' + t.capturePhotoButton;
            if (retakePhotoButton) retakePhotoButton.querySelector('i').nextSibling.textContent = ' ' + t.retakePhotoButton;
            if (aiLoadingText) aiLoadingText.textContent = t.analyzingImage;
        }

        // Función para mostrar la sección del mapa correcta y ocultar las otras
        function showMapSection(lang) {
            codeEntrySection.classList.add('hidden');
            esMapSection.classList.remove('flex'); // Asegurarse de quitar flex para ocultar correctamente
            esMapSection.classList.add('hidden');
            enMapSection.classList.remove('flex');
            enMapSection.classList.add('hidden');
            frMapSection.classList.remove('flex'); // Ocultar también la sección de francés
            frMapSection.classList.add('hidden');

            if (lang === 'es') {
                esMapSection.classList.remove('hidden');
                esMapSection.classList.add('flex');
            } else if (lang === 'en') {
                enMapSection.classList.remove('hidden');
                enMapSection.classList.add('flex');
            } else if (lang === 'fr') { // Mostrar la sección de francés
                frMapSection.classList.remove('hidden');
                frMapSection.classList.add('flex');
            }
            // Asegúrate de que el contenido del mapa se actualice al cambiar de idioma
            updateContent(lang);
        }

        // --- Gestión de eventos ---

        // Alternar el menú desplegable de idiomas
        languageToggleButton.addEventListener('click', (event) => {
            languageDropdown.classList.toggle('active');
            event.stopPropagation(); // Evita que el clic se propague y cierre el menú inmediatamente
        });

        // Cerrar el menú desplegable al hacer clic fuera
        document.addEventListener('click', (event) => {
            if (!languageDropdown.contains(event.target) && !languageToggleButton.contains(event.target)) {
                languageDropdown.classList.remove('active');
            }
            // Cerrar también los desplegables de leyenda si están abiertos
            if (legendDropdownEs && legendDropdownEs.classList.contains('active') && !legendToggleEs.contains(event.target) && !legendDropdownEs.contains(event.target)) {
                legendDropdownEs.classList.remove('active');
            }
            if (legendDropdownEn && legendDropdownEn.classList.contains('active') && !legendToggleEn.contains(event.target) && !legendDropdownEn.contains(event.target)) {
                legendDropdownEn.classList.remove('active');
            }
            if (legendDropdownFr && legendDropdownFr.classList.contains('active') && !legendToggleFr.contains(event.target) && !legendDropdownFr.contains(event.target)) {
                legendDropdownFr.classList.remove('active');
            }

            // Close chatbot panels if clicked outside
            if (chatbotPanelEs && chatbotPanelEs.classList.contains('active') && !chatbotPanelEs.contains(event.target) && !chatbotToggleEs.contains(event.target)) {
                chatbotPanelEs.classList.remove('active');
            }
            if (chatbotPanelEn && chatbotPanelEn.classList.contains('active') && !chatbotPanelEn.contains(event.target) && !chatbotToggleEn.contains(event.target)) {
                chatbotPanelEn.classList.remove('active');
            }
            if (chatbotPanelFr && chatbotPanelFr.classList.contains('active') && !chatbotPanelFr.contains(event.target) && !chatbotToggleFr.contains(event.target)) {
                chatbotPanelFr.classList.remove('active');
            }
            
            // Close AI photo panel if clicked outside
            if (aiPhotoPanel && aiPhotoPanel.classList.contains('active') && !aiPhotoPanel.contains(event.target) && !aiPhotoToggle.contains(event.target)) {
                aiPhotoPanel.classList.remove('active');
                stopCamera(); // Also stop camera when closing from outside click
            }
        });

        // Cambiar idioma al seleccionar una opción
        languageItems.forEach(item => {
            item.addEventListener('click', () => {
                currentLang = item.dataset.lang;
                updateContent(currentLang);
                languageDropdown.classList.remove('active');
                // Si ya estamos en una sección de mapa, actualizarla al nuevo idioma
                if (!codeEntrySection.classList.contains('hidden')) { // Si estamos en la pantalla de código
                    // No hacer nada, el idioma se aplicará cuando se valide el código
                } else { // Si ya estamos en una sección de mapa
                    // Determinar qué mapa está actualmente visible y cambiar su idioma
                    if (!esMapSection.classList.contains('hidden')) {
                        showMapSection('es'); // Forzar la actualización del mapa ES con el nuevo idioma
                    } else if (!enMapSection.classList.contains('hidden')) {
                        showMapSection('en'); // Forzar la actualización del mapa EN con el nuevo idioma
                    } else if (!frMapSection.classList.contains('hidden')) {
                        showMapSection('fr'); // Forzar la actualización del mapa FR con el nuevo idioma
                    }
                }
            });
        });

        // Inicializar contenido con el idioma por defecto
        updateContent(currentLang);

        // --- Lógica del formulario (RESTAURADO Y MEJORADO) ---
        const codeForm = document.getElementById('code-form');

        // IMPORTANTE: Esta es la URL de tu Google App Script que maneja el doPost
        const APP_SCRIPT_VALIDATION_URL = 'https://script.google.com/macros/s/AKfycbzUyJfJtItPTqhueAFuK3ltfbuYK4hSE8nXO5Hv6EkfiMajmLSSv0HuUrMadW5-diBabA/exec';

        codeForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const code = codeInput.value.trim();

            messageBox.classList.add('hidden');
            messageBox.textContent = ''; // Limpiar mensajes anteriores
            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;
            codeInput.disabled = true;

            try {
                // Enviar el código como application/x-www-form-urlencoded para compatibilidad con doPost
                const response = await fetch(APP_SCRIPT_VALIDATION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ codigo: code }) // Envía el código como 'codigo=VALOR'
                });

                const result = await response.json();

                if (result.valido) { // Tu App Script devuelve 'valido'
                    let mapLanguage = 'es'; // Default to Spanish
                    if (result.urlRedireccion.includes('illustrious-sherbet')) {
                        mapLanguage = 'es';
                    } else if (result.urlRedireccion.includes('scintillating-capybara')) {
                        mapLanguage = 'en';
                    } else if (result.urlRedireccion.includes('dashing-crisp')) { // NUEVO: Lógica para el mapa francés
                        mapLanguage = 'fr';
                    }
                    
                    currentLang = mapLanguage; // Actualizar el idioma global
                    showMapSection(mapLanguage); // Mostrar la sección del mapa correspondiente

                    // Establecer el mensaje inicial del chatbot según el idioma
                    if (mapLanguage === 'es') {
                        initializeChatbot('es', chatbotMessagesEs, chatbotInputEs, chatbotSendEs);
                    } else if (mapLanguage === 'en') {
                        initializeChatbot('en', chatbotMessagesEn, chatbotInputEn, chatbotSendEn);
                    } else if (mapLanguage === 'fr') { // NUEVO: Inicializar chatbot francés
                        initializeChatbot('fr', chatbotMessagesFr, chatbotInputFr, chatbotSendFr);
                    }

                } else {
                    // Mostrar mensaje de error específico del App Script
                    let errorMessage = translations[currentLang].invalidCode; // Mensaje por defecto
                    if (result.mensaje === 'Este código ha caducado.' || result.mensaje === 'This code has expired.') {
                        errorMessage = translations[currentLang].codeExpired;
                    } else if (result.mensaje === 'Este código ha excedido el número máximo de usos.' || result.mensaje === 'This code has exceeded the maximum number of uses.') {
                        errorMessage = translations[currentLang].usageLimitExceeded;
                    } else if (result.mensaje) {
                        errorMessage = result.mensaje; // Otros mensajes específicos del App Script
                    }
                    messageBox.textContent = errorMessage;
                    messageBox.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error validating code:', error);
                messageBox.textContent = 'Error de conexión. Por favor, inténtalo de nuevo más tarde.';
                messageBox.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
                codeInput.disabled = false;
            }
        });

        // --- Lógica del mapa y pantalla completa ---
        // Función para detectar iOS
        function isIOS() {
            return [
                    'iPad Simulator',
                    'iPhone Simulator',
                    'iPod Simulator',
                    'iPad',
                    'iPhone',
                    'iPod'
                ].includes(navigator.platform)
                // iPad on iOS 13+ detection
                || (navigator.userAgent.includes("Mac") && "ontouchend" in document)
                ;
        }

        function requestFullscreen(element) {
            if (element.requestFullscreen) {
                element.requestFullscreen();
            } else if (element.mozRequestFullScreen) { /* Firefox */
                element.mozRequestFullScreen();
            } else if (element.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                element.webkitRequestFullscreen();
            } else if (element.msRequestFullscreen) { /* IE/Edge */
                element.msRequestFullscreen();
            }
        }

        fullscreenEsMapButton.addEventListener('click', () => {
            if (isIOS()) {
                window.open(esMapIframe.src, '_blank'); // Abre en una nueva pestaña
            } else {
                requestFullscreen(esMapIframe); // Comportamiento actual para otros dispositivos
            }
        });

        fullscreenEnMapButton.addEventListener('click', () => {
            if (isIOS()) {
                window.open(enMapIframe.src, '_blank');
            } else {
                requestFullscreen(enMapIframe);
            }
        });

        fullscreenFrMapButton.addEventListener('click', () => { // NUEVO para francés
            if (isIOS()) {
                window.open(frMapIframe.src, '_blank');
            } else {
                requestFullscreen(frMapIframe);
            }
        });

        // --- Lógica de Leyenda ---
        if (legendToggleEs) {
            legendToggleEs.addEventListener('click', (event) => {
                legendDropdownEs.classList.toggle('active');
                event.stopPropagation();
            });
        }
        if (legendToggleEn) {
            legendToggleEn.addEventListener('click', (event) => {
                legendDropdownEn.classList.toggle('active');
                event.stopPropagation();
            });
        }
        if (legendToggleFr) {
            legendToggleFr.addEventListener('click', (event) => {
                legendDropdownFr.classList.toggle('active');
                event.stopPropagation();
            });
        }


        // --- Lógica del Chatbot ---

        function addMessageToChat(chatMessagesElement, text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chatbot-message', sender);
            if (sender === 'bot' && text === 'typing') {
                messageElement.innerHTML = '<span class="chatbot-loading-dots"></span><span class="chatbot-loading-dots"></span><span class="chatbot-loading-dots"></span>';
            } else {
                messageElement.textContent = text;
            }
            chatMessagesElement.appendChild(messageElement);
            chatMessagesElement.scrollTop = chatMessagesElement.scrollHeight; // Auto-scroll
        }

        async function getChatbotResponse(lang, message, chatHistory) {
            // Añadir el mensaje del usuario al historial
            chatHistory.push({ role: "user", parts: [{ text: message }] });

            // Mostrar el mensaje del usuario en el chat
            const chatMessagesElement = document.getElementById(`chatbot-messages-${lang}`);
            addMessageToChat(chatMessagesElement, message, 'user');

            // Mostrar indicador de carga
            addMessageToChat(chatMessagesElement, 'typing', 'bot');

            // --- CAMBIO CLAVE AQUÍ: Llama a tu función de Netlify, no directamente a Gemini ---
            const netlifyFunctionUrl = '/.netlify/functions/chatbot'; // Ajusta esta URL si tu función tiene otra ruta
            
            try {
                const payload = { contents: chatHistory };
                const response = await fetch(netlifyFunctionUrl, { // Usa la URL de la función de Netlify
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                let botResponse = translations[lang].chatbotErrorMessage; // Mensaje de error por defecto

                // La función de Netlify devuelve { text: "..." }, no la estructura completa de Gemini
                if (result && result.text) {
                    botResponse = result.text;
                } else if (result && result.error) {
                    // Si la función de Netlify devuelve un error específico
                    botResponse = `Error del servidor: ${result.error}`;
                }

                // Eliminar el indicador de carga
                chatMessagesElement.removeChild(chatMessagesElement.lastChild);

                // Añadir la respuesta del bot al historial
                chatHistory.push({ role: "model", parts: [{ text: botResponse }] });

                // Mostrar la respuesta del bot
                addMessageToChat(chatMessagesElement, botResponse, 'bot');
            } catch (error) {
                console.error("Error fetching chatbot response:", error);
                chatMessagesElement.removeChild(chatMessagesElement.lastChild); // Eliminar carga
                addMessageToChat(chatMessagesElement, translations[lang].chatbotErrorMessage + ` (${error.message})`, 'bot');
                chatHistory.push({ role: "model", parts: [{ text: translations[lang].chatbotErrorMessage }] }); // Añadir mensaje de error al historial
            }
        }

        // Función para inicializar o resetear el chat
        function initializeChatbot(lang, chatMessagesElement, chatbotInput, chatbotSend) {
            chatMessagesElement.innerHTML = ''; // Limpiar mensajes anteriores
            const currentChatHistory = chatHistories[lang];
            currentChatHistory.length = 0; // Vaciar el historial
            addMessageToChat(chatMessagesElement, translations[lang].chatbotInitialMessage, 'bot');
            currentChatHistory.push({ role: "model", parts: [{ text: translations[lang].chatbotInitialMessage }] }); // Añadir al historial

            chatbotSend.onclick = () => {
                const message = chatbotInput.value.trim();
                if (message) {
                    getChatbotResponse(lang, message, currentChatHistory);
                    chatbotInput.value = '';
                }
            };

            chatbotInput.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    chatbotSend.click();
                }
            };
        }

        // Event listeners para los toggles del chatbot
        if (chatbotToggleEs) {
            chatbotToggleEs.addEventListener('click', () => {
                chatbotPanelEs.classList.toggle('active');
                if (aiPhotoPanel) aiPhotoPanel.classList.remove('active'); // Close AI panel
                if (chatbotPanelEs.classList.contains('active') && chatHistories['es'].length === 0) {
                    initializeChatbot('es', chatbotMessagesEs, chatbotInputEs, chatbotSendEs);
                }
            });
            chatbotCloseEs.addEventListener('click', () => {
                chatbotPanelEs.classList.remove('active');
            });
        }

        if (chatbotToggleEn) {
            chatbotToggleEn.addEventListener('click', () => {
                chatbotPanelEn.classList.toggle('active');
                if (aiPhotoPanel) aiPhotoPanel.classList.remove('active'); // Close AI panel
                if (chatbotPanelEn.classList.contains('active') && chatHistories['en'].length === 0) {
                    initializeChatbot('en', chatbotMessagesEn, chatbotInputEn, chatbotSendEn);
                }
            });
            chatbotCloseEn.addEventListener('click', () => {
                chatbotPanelEn.classList.remove('active');
            });
        }

        if (chatbotToggleFr) {
            chatbotToggleFr.addEventListener('click', () => {
                chatbotPanelFr.classList.toggle('active');
                if (aiPhotoPanel) aiPhotoPanel.classList.remove('active'); // Close AI panel
                if (chatbotPanelFr.classList.contains('active') && chatHistories['fr'].length === 0) {
                    initializeChatbot('fr', chatbotMessagesFr, chatbotInputFr, chatbotSendFr);
                }
            });
            chatbotCloseFr.addEventListener('click', () => {
                chatbotPanelFr.classList.remove('active');
            });
        }

        // New AI Photo Guide toggle
        if (aiPhotoToggle) {
            aiPhotoToggle.addEventListener('click', () => {
                aiPhotoPanel.classList.toggle('active');
                // Close all chatbot panels
                if (chatbotPanelEs) chatbotPanelEs.classList.remove('active');
                if (chatbotPanelEn) chatbotPanelEn.classList.remove('active');
                if (chatbotPanelFr) chatbotPanelFr.classList.remove('active');

                if (aiPhotoPanel.classList.contains('active')) {
                    startCamera(); // Start camera when panel opens
                    getGeolocation(); // Try to get geolocation when panel opens
                } else {
                    stopCamera(); // Stop camera when panel closes
                }
            });
            aiPhotoClose.addEventListener('click', () => {
                aiPhotoPanel.classList.remove('active');
                stopCamera(); // Stop camera when panel closes
            });
        }

        async function startCamera() {
            try {
                // Hide any previous image
                capturedImage.classList.add('hidden');
                cameraPreview.classList.remove('hidden');
                retakePhotoButton.classList.add('hidden');
                capturePhotoButton.classList.remove('hidden');
                aiResponseText.textContent = ''; // Clear previous AI response
                aiResponseArea.classList.add('hidden'); // Hide AI response area initially

                aiPhotoInitialMessage.textContent = translations[currentLang].aiPhotoInitialMessage; // Reset initial message
                aiPhotoMessages.classList.remove('hidden'); // Ensure messages are visible

                // Request camera permission
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); // Prefer rear camera
                cameraPreview.srcObject = stream;
                currentStream = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                aiPhotoInitialMessage.textContent = "Error al acceder a la cámara. Por favor, asegúrate de que tienes una cámara y has dado permiso.";
                aiPhotoMessages.classList.remove('hidden');
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                cameraPreview.srcObject = null;
            }
        }

        capturePhotoButton.addEventListener('click', () => {
            if (currentStream) {
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = cameraPreview.videoWidth;
                photoCanvas.height = cameraPreview.videoHeight;
                context.drawImage(cameraPreview, 0, 0, photoCanvas.width, photoCanvas.height);
                
                const imageDataUrl = photoCanvas.toDataURL('image/jpeg', 0.9); // Get image as JPEG base64
                capturedImage.src = imageDataUrl;
                capturedImage.classList.remove('hidden');
                cameraPreview.classList.add('hidden');

                capturePhotoButton.classList.add('hidden');
                retakePhotoButton.classList.remove('hidden');

                stopCamera(); // Stop camera after capture
                sendPhotoToAI(imageDataUrl);
            }
        });

        retakePhotoButton.addEventListener('click', () => {
            capturedImage.classList.add('hidden');
            cameraPreview.classList.remove('hidden');
            retakePhotoButton.classList.add('hidden');
            capturePhotoButton.classList.remove('hidden');
            aiResponseText.textContent = ''; // Clear previous AI response
            aiResponseArea.classList.add('hidden'); // Hide AI response area
            startCamera(); // Restart camera
        });

        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if ("geolocation" in navigator) {
                    geoStatus.textContent = translations[currentLang].geoStatusLoading;
                    geoCoords.textContent = '';
                    geolocationInfo.classList.remove('hidden');

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            currentLatitude = position.coords.latitude;
                            currentLongitude = position.coords.longitude;
                            geoStatus.textContent = "Ubicación obtenida:";
                            geoCoords.textContent = `Lat: ${currentLatitude.toFixed(6)}, Lon: ${currentLongitude.toFixed(6)}`;
                            resolve({ lat: currentLatitude, lon: currentLongitude });
                        },
                        (error) => {
                            console.error("Error getting geolocation: ", error);
                            geoStatus.textContent = translations[currentLang].geoStatusError;
                            geoCoords.textContent = '';
                            currentLatitude = null;
                            currentLongitude = null;
                            reject(error);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                } else {
                    geoStatus.textContent = "Geolocalización no soportada por este navegador.";
                    geoCoords.textContent = '';
                    geolocationInfo.classList.remove('hidden');
                    reject(new Error("Geolocation not supported."));
                }
            });
        }

        async function sendPhotoToAI(imageDataUrl) {
            aiResponseText.textContent = ''; // Clear previous response
            aiResponseArea.classList.remove('hidden'); // Ensure response area is visible
            aiLoadingIndicator.classList.remove('hidden');
            aiLoadingText.textContent = translations[currentLang].analyzingImage;

            let geolocationData = null;
            try {
                geolocationData = await getGeolocation();
            } catch (geoError) {
                console.warn("Could not get geolocation, proceeding without it:", geoError);
                // Optionally inform user that location is not available but photo will still be analyzed
            }

            // Remove 'data:image/jpeg;base64,' prefix for sending
            const base64Image = imageDataUrl.split(',')[1];
            
            const netlifyFunctionUrl = '/.netlify/functions/analyze-photo-ai'; // Your Netlify Function URL

            try {
                const payload = {
                    image: base64Image,
                    location: geolocationData ? { lat: geolocationData.lat, lon: geolocationData.lon } : null,
                    lang: currentLang // Send current language for localized response if function supports it
                };

                const response = await fetch(netlifyFunctionUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                aiLoadingIndicator.classList.add('hidden');

                if (result && result.response) {
                    aiResponseText.textContent = result.response;
                } else if (result && result.error) {
                    aiResponseText.textContent = `Error: ${result.error}`;
                } else {
                    aiResponseText.textContent = translations[currentLang].aiResponseError;
                }
            } catch (error) {
                console.error("Error sending photo to AI function:", error);
                aiLoadingIndicator.classList.add('hidden');
                aiResponseText.textContent = translations[currentLang].aiResponseError + ` (${error.message})`;
            }
        }


        // Inicializar el contenido al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            // Determinar el idioma preferido del navegador o usar el español por defecto
            const browserLang = navigator.language.split('-')[0];
            if (translations[browserLang]) {
                currentLang = browserLang;
            } else {
                currentLang = 'es'; // Fallback a español
            }
            updateContent(currentLang);
        });

    </script>
</body>
</html>
